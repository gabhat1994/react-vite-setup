import{aa as Y,hk as te,ab as Z,hf as J,j as n,ho as W,f as R,hj as A,dy as ie,iN as ke,hh as H,aH as Te,iO as le,iP as Ie,iQ as Ue,iR as Pe,hl as Oe,aC as ce,iS as Le,au as F,iw as de,hR as ue,T as D,c as U,hc as se,F as $,iT as Ne,hg as Ae,I as X,iU as _e,iV as fe,iW as ge,iX as pe,iY as he,iZ as Ee,i_ as Be,i$ as De,n as Ve,ay as ve,j0 as We,j1 as ae,j2 as ne,M as Re,t as He,h as je,i as Ge,x as z,aK as Fe,S as $e,j3 as ze,q as Qe,b7 as Ce,u as Je,j4 as Ye,fG as Ze,fH as Ke,j5 as qe,fI as Xe,fJ as et,fK as tt,j6 as st,j7 as at,j8 as nt,c4 as ot,j9 as rt,ja as it,jb as lt,jc as ct,jd as dt,B as ut,o as ft,je as gt,am as pt,jf as ht,fL as vt,fp as Ct,e8 as bt}from"./index-cd84bcc9.js";import{r as e,f as q,aN as mt,l as G,aL as Mt,C as P,ar as j,B as xt,al as wt}from"./vendor-51460554.js";const Xt=({children:t})=>{const a=Y(),[s,h]=e.useState(te.DEFAULT),r=e.useCallback(v=>{a===Z.MOBILE?h(v):h(te.DEFAULT)},[a]),[l,i]=e.useState(!1),[p,c]=e.useState(J.GLOBAL_ALL),[u,d]=e.useState(0),o=e.useMemo(()=>({viewMode:s,setViewMode:r,isNewConversation:l,setIsNewConversation:i,conversationType:p,setConversationType:c,conversationWrapperWidth:u,setConversationWrapperWidth:d}),[p,u,l,r,s]);return n(W.Provider,{value:o,children:t})},es=({children:t})=>{const{user:a}=R(),[s,h]=e.useState(""),{conversation:r}=A.useConversation({sid:s}),[l,i]=e.useState({}),p=e.useRef(l);e.useEffect(()=>{p.current=l},[l]);const c=e.useMemo(()=>l[s]||[],[l,s]),{setMutedConversationId:u}=e.useContext(ie);e.useLayoutEffect(()=>(u(s),()=>u(null)),[s,u]);const d=e.useCallback(C=>{if(!r)return;const M={...C,send:C.send,attributes:C.attributes,mediaContent:C.mediaContent,author:(a==null?void 0:a._id)||null,dateCreated:new Date,index:-1,conversation:r,status:{status:"sending"}};i(f=>({...f,[s]:[...f[s]||[],M]}))},[r,s,a==null?void 0:a._id]),o=e.useCallback((C,M)=>{const f=p.current[s]||[],x=f.findIndex(S=>S.attributes.id===C);if(x>-1){const S={...f[x],...M},w=ke(f,x,S);i(T=>({...T,[s]:[...w]}))}},[s]),v=e.useCallback(C=>{i(M=>{var f;return{...M,[s]:(f=M[s])==null?void 0:f.filter(x=>x.attributes.id!==C)}})},[s]),m=e.useCallback(C=>{var x;const M=p.current[s]||[],f=M.findIndex(S=>S.attributes.id===C);if(f>-1){const S=M[f];S.index>-1||((x=S.status)==null?void 0:x.status)==="failed"?(o(C,{status:{status:"sending"}}),M[f].send().then(T=>{T!==null&&o(C,{status:{status:"sent"},index:T})}).catch(()=>{o(C,{status:{status:"failed"}})})):o(C,{status:{status:"sent"}})}},[s,o]),b=e.useMemo(()=>({activeConversationSid:s,setActiveConversationSid:h,addPendingMessage:d,updatePendingMessage:o,removePendingMessage:v,resendErrorMessage:m,pendingMessages:c}),[s,c,d,v,m,o]);return n(H.Provider,{value:b,children:t})},St={isConversationCreatable:!1,loading:!1,ecLoading:!1,selectedUsers:[],setSelectedUsers:()=>{},createNewConversation:async()=>{},createHomeNoumNewConversation:async()=>{}},be=e.createContext(St),yt=t=>!!(t&&t.__typename==="ConversationOutput"),kt=t=>!!(t&&t.__typename==="ConversationOutput"),ts=({children:t,onCreated:a})=>{const{user:s}=R(),{spaceId:h,isMasterNoum:r}=Te(),{client:l}=e.useContext(le),{isNewConversation:i,setIsNewConversation:p}=e.useContext(W),{activeConversationSid:c,setActiveConversationSid:u}=e.useContext(H),[d]=Ie(),[o]=Ue(),[v]=Pe(),[m,b]=e.useState([]);e.useEffect(()=>{i||b([])},[i]);const[C,M]=e.useState(!1),[f,x]=e.useState(!1),S=e.useMemo(()=>m.map(I=>I._id),[m]),w=e.useMemo(()=>(i||c===Oe)&&S.length>0,[c,i,S.length]),T=e.useCallback(async()=>{if(!(!l||!w))try{M(!0);const{data:I}=await d({variables:{userIds:S,spaceId:h||""}});if(!I){const g=new Error("[handleCreateConversation] No data returned");throw q(g,{tags:{section:"CreateNewConversation"}}),g}const{getOrCreateSpaceConversation:O}=I;if(yt(O)){const g=O.cid;if(g){const _=await l.getConversationBySid(g);return u(g),p(!1),a==null||a(g),_}}return}finally{M(!1)}},[l,d,w,a,S,u,p,h]),y=e.useCallback(async()=>{if(!(!l||!w))try{M(!0);const{data:I}=await o({variables:{userIds:S}});if(!I){const g=new Error("[handleCreateConversation] No data returned");throw q(g,{tags:{section:"CreateNewConversation"}}),g}const{getOrCreateGlobalConversation:O}=I;if(kt(O)){const g=O.cid;if(g){const _=await l.getConversationBySid(g);return u(g),p(!1),a==null||a(g),_}}return}finally{M(!1)}},[l,o,w,a,S,u,p]),E=e.useMemo(()=>({isConversationCreatable:w,loading:C,ecLoading:f,selectedUsers:m,setSelectedUsers:b,createNewConversation:T,createHomeNoumNewConversation:y}),[w,C,f,m,b,T,y]);return e.useEffect(()=>{(async()=>{var I;if(i){if(x(!0),S.length>0){const{data:O}=await v({variables:{spaceId:r?void 0:h,userIds:ce([...S,s==null?void 0:s._id])}}),g=(I=O==null?void 0:O.getConversation)==null?void 0:I.cid;u(g??"")}else u("");x(!1)}})()},[v,r,i,S,u,h,s==null?void 0:s._id]),n(be.Provider,{value:E,children:t})},ss=({children:t,onLoadConversations:a})=>{const s=mt(),[h]=Le(),[r,l]=e.useState(),[i,p]=e.useState(),[c,u]=e.useState(!1),[d,o]=e.useState(!1),v=e.useRef([]),{addMessage:m}=A.useMessageHandlers(),{conversationType:b}=e.useContext(W),{bulkAddConversations:C,updateConversation:M,removeConversation:f}=A.useConversationHandlers(b),{addConversationParticipant:x,updateConversationParticipant:S,removeConversationParticipant:w}=A.useParticipantHandlers(),T=e.useMemo(()=>G.throttle(()=>{C({conversations:v.current,isInitialized:d}),v.current=[]},300,{leading:!1,trailing:!0}),[C,d]),y=e.useMemo(()=>G.debounce(()=>o(!0),1500),[]),E=e.useCallback(g=>{v.current.push(g),T(),y()},[T,y]),I=e.useCallback(async()=>{if(i){u(!1);const g=new Mt.Client(i);l(g)}},[i]);e.useEffect(()=>{if(c)return;(async()=>{var _,V,Q;try{const{data:N}=await h();console.log("[TwilioV2] generating new token: ",(_=N==null?void 0:N.createTwilioToken)==null?void 0:_.token),(V=N==null?void 0:N.createTwilioToken)!=null&&V.token&&p((Q=N==null?void 0:N.createTwilioToken)==null?void 0:Q.token)}catch(N){console.log("[TwilioV2] generating token failed:",N),q(N)}})()},[h,c]),e.useEffect(()=>{c||I()},[I,c]),e.useEffect(()=>{d&&(console.log("[TwilioV2] conversations list loaded"),a==null||a())},[d,a]),e.useEffect(()=>{r&&(r.on("stateChanged",g=>{console.log("[TwilioV2] stateChanged",g),g==="initialized"&&u(!0)}),r.on("connectionStateChanged",async g=>{console.log("[TwilioV2] connectionStateChanged:",g),(g==="disconnecting"||g==="disconnected")&&I()}))},[I,r]),e.useEffect(()=>{if(!(!r||!c))return r.getSubscribedConversations().then(()=>{o(!0)}),r.on("conversationJoined",g=>{g.lastMessage&&E(g)}),r.on("conversationUpdated",({conversation:g,updateReasons:_})=>{console.log("[TwilioV2] conversationUpdated:",g.sid,"reasons:",_),M({conversation:g})}),r.on("conversationLeft",g=>{f({conversation:g})}),r.on("participantJoined",g=>{x({participant:g})}),r.on("participantUpdated",({participant:g,updateReasons:_})=>{_.includes("lastReadMessageIndex")&&S({participant:g})}),r.on("participantLeft",g=>{w({participant:g})}),r.on("messageAdded",g=>{m({message:g})}),()=>{r.removeAllListeners()}},[x,m,E,I,c,f,w,r,M,S]),e.useEffect(()=>()=>s==null?void 0:s.clear(),[s]);const O=e.useMemo(()=>({client:r,isInitialized:d}),[r,d]);return n(le.Provider,{value:O,children:t})},Tt=({size:t,users:a})=>{const s=a.map(h=>h.source);return s&&s.length===1?n(F,{"data-testid":"avatar-testid",url:s[0],size:t==="L"?"L":"M","data-test":"ChatItemAvatar-Avatar"}):s&&s.length===2?n(de,{"data-testid":"diagonalavatar-testid",urls:s,size:t==="L"?"L":"M","data-test":"ChatItemAvatar-DiagonalAvatar2"}):s&&s.length>2?n(ue,{"data-testid":"diagonalavatar3-testid",urls:s,size:t==="L"?"L":"M","data-test":"ChatItemAvatar-DiagonalAvatar3"}):null},me=P.div`
  display: flex;
  flex-direction: row;
  align-items: center;
  padding: ${({size:t})=>t==="L"?"16px":t==="M"?"12px 16px 12px 32px":"12px 14px"};
  box-sizing: border-box;
  border-bottom: 1px solid var(--bg-separator-neutral-default);
  width: 100%;
  min-height: ${({size:t})=>t==="L"?"78px":t==="M"?"70px":"65px"};
  cursor: pointer;
  ${t=>t.active?"border-left: 2px solid var(--bg-tab-indicator-primary-brand-default);":"border-left: 2px solid transparent;"}
  ${t=>t.active&&"background-color: var(--bg-separator-neutral-default);"}
`,It=P.div`
  width: ${({size:t})=>t==="L"?"40px":"24px"};
  height: ${({size:t})=>t==="L"?"40px":"24px"};
`,Me=P.div`
  width: 100%;
  overflow: hidden;
  justify-content: center;
  margin-left: 16px;
`,as=P.div`
  position: relative;
  cursor: pointer;
  margin-right: ${t=>(t.isMarginRight,"24px")};
`,ns=P.div`
  position: absolute;
  bottom: -5px;
  right: -5px;
`,Ut=P.div`
  display: flex;
  flex-direction: row;
  align-items: center;
`,Pt=P.div`
  width: 8px;
  height: 8px;
  background: var(--bg-badge-danger-primary-default);
  border-radius: 1000px;
  margin-right: 8px;
`,Ot=P(D).attrs({font:"footnote"})`
  margin: 0 3px;
`,Lt=P(D).attrs({font:"footnote"})``,Nt=P(D).attrs({overflow:"ellipsis",colorToken:"--text-tablecell-body-neutral-highlighted"})`
  display: block;
`,oe=P(D).attrs({overflow:"ellipsis",colorToken:"--text-tablecell-body-neutral-default"})`
  display: block;
`,At=({sid:t,isActive:a=!1,size:s="S",onClick:h,noumLayoutViewMode:r,users:l,title:i,messages:p,unread:c,lastMessageHasAsset:u,author:d,lastMessage:o})=>{const{t:v}=j(),m=e.useMemo(()=>s==="L"?c!==0?"body-m-bold":"body-m":s==="M"?"body-m":"footnote",[s,c]);return U(me,{"data-testid":"chatitem-testid",active:a,size:s,onClick:()=>h(t),children:[n(It,{size:s,children:n(Tt,{users:l,size:r===se.NOUMLAYOUTCOMPACT?"M":s,"data-test":"ChatItemView-ChatItemAvatar"})}),r!==se.NOUMLAYOUTCOMPACT&&U(Me,{children:[n(Nt,{font:s==="S"?"body-m-bold":"body-l-bold",colorToken:"--text-tablecell-header-neutral-highlighted",children:i}),!!l.length&&p&&U(Ut,{children:[c!==0&&n(Pt,{"data-testid":"messagestatus-testid"}),u&&n(oe,{font:m,colorToken:"--text-tablecell-body-neutral-default",children:v("noumena.chat.user_sent_an_asset",{user:d})}),(o==null?void 0:o.body)&&U(oe,{font:m,flex:1,colorToken:"--text-tablecell-body-neutral-default",children:[d&&`${d}: `,`${o.body.trim()}`]}),(o==null?void 0:o.dateCreated)&&U($,{children:[n(Ot,{colorToken:"--text-tablecell-body-neutral-disabled",children:"·"}),n(Lt,{colorToken:"--text-timestamp-neutral-default",children:Ne(new Date(o.dateCreated))})]})]})]})]})},os=({sid:t,onRead:a,...s})=>{const{t:h}=j(),{user:r}=R(),{conversation:l}=A.useConversation({sid:t}),{messages:i}=A.useConversationMessages({sid:t}),{users:p,title:c,getParticipantById:u}=A.useConversationDetails({sid:t}),{noumLayoutViewMode:d}=e.useContext(Ae),o=e.useMemo(()=>i[i.length-1],[i]),v=A.useConversationUnreadMessageCount({sid:t}),{author:m,lastMessageHasAsset:b}=e.useMemo(()=>{var f,x;let C="",M;return l&&(M=(f=o==null?void 0:o.attachedMedia)==null?void 0:f[0],o!=null&&o.author&&(r!=null&&r._id)&&(o.author===r._id?C=h("noumena.chat.you"):C=`${((x=u(o.author))==null?void 0:x.firstName)??""}`)),{author:C,lastMessageHasAsset:M}},[l,u,o,h,r]);return e.useEffect(()=>{l&&(o==null?void 0:o.author)===(r==null?void 0:r._id)&&l.setAllMessagesRead()},[l,o==null?void 0:o.author,r==null?void 0:r._id]),e.useEffect(()=>{v||a==null||a()},[a,v]),n(At,{noumLayoutViewMode:d,author:m,lastMessageHasAsset:b,users:p,title:c,messages:i,unread:v,lastMessage:o,sid:t,...s,"data-test":"ChatItem-ChatItemView"})},rs=({size:t})=>{const{t:a}=j();return U(me,{active:!0,size:t,"data-test":"NewChatItem-ChatItemWrapper",children:[n(X,{"data-testid":"chat_new_icon-testid",name:"chat_new",size:24,color:"--icon-tablecell-neutral-highlighted","data-test":"NewChatItem-Icon"}),n(Me,{"data-test":"NewChatItem-Content",children:n(D,{font:t==="L"?"body-l-bold":"body-m-bold",colorToken:"--text-tablecell-header-neutral-highlighted","data-test":"NewChatItem-TSpan",children:a("noumena.chatItem.title")})})]})};function _t(t,a=void 0){const[s,h]=e.useState(!1),r=l=>{const[i]=l;h(i.isIntersecting)};return e.useEffect(()=>{const l=t.current,i=new IntersectionObserver(r,a);return l&&i.observe(l),()=>{l&&i.unobserve(l)}},[a,t]),s}const Et=({message:t,prev:a,next:s,sameTypeNext:h})=>{var C;const r=e.useRef(null),l=_t(r,{root:document.querySelector("body"),rootMargin:"0px",threshold:.5}),{conversationType:i,conversationWrapperWidth:p}=e.useContext(W),c=_e(i,p),{activeConversationSid:u,removePendingMessage:d}=e.useContext(H),{conversation:o}=A.useConversation({sid:u}),{readConversation:v}=e.useContext(ie),{messageBubbleProps:m}=A.useMessageBubbleProps({message:t,prev:a,next:s,sameTypeNext:h}),b=(C=t.attachedMedia)==null?void 0:C[0];return e.useEffect(()=>{const M=t.attributes;M!=null&&M.id&&d(M.id)},[t.attributes,d]),e.useEffect(()=>{!s&&l&&(async()=>(await(o==null?void 0:o.setAllMessagesRead()),v(u)))()},[u,o,l,s,v]),m?n($,{children:b?fe(b.contentType)==="video"?n(ge,{"data-testid":"video-message-bubble",...m,media:b,ref:r,"data-test":"MessageItem-VideoMessageBubble"}):n(pe,{"data-testid":"image-message-bubble",...m,media:b,ref:r,"data-test":"MessageItem-ImageMessageBubble"}):t.body&&n(he,{"data-testid":"text-message-bubble",...m,maxWidth:c,ref:r,"data-test":"MessageItem-TextMessageBubble"})}):null},Bt=({message:t,prev:a,next:s,sameTypeNext:h})=>{const l=Y()===Z.MOBILE,{conversationType:i}=e.useContext(W),c=Ee(i)&&!l?"600px":void 0,{resendErrorMessage:u}=e.useContext(H),{pendingMessageBubbleProps:d}=A.useMessageBubbleProps({message:t,prev:a,next:s,sameTypeNext:h}),o=Be(t),v=e.useCallback(m=>{u(m)},[u]);return o?n($,{children:fe(o.type)==="image"?n(pe,{...d,pendingFile:o,onResend:v,"data-test":"PendingMessageItem-ImageMessageBubble"}):n(ge,{...d,pendingFile:o,onResend:v,"data-test":"PendingMessageItem-VideoMessageBubble"})}):t.text?n(he,{...d,maxWidth:c,message:t.text,onResend:v,"data-test":"PendingMessageItem-TextMessageBubble"}):null},Dt=P.div`
  position: relative;
  padding: 32px;
`,is=()=>{const t=e.useRef(null),{user:a}=R(),{activeConversationSid:s}=e.useContext(H),{isGroupConversation:h}=A.useConversationDetails({sid:s}),{messages:r,pendingMessages:l,isFetched:i,isLoading:p,status:c,hasPreviousPage:u,fetchPreviousMessages:d}=A.useConversationMessages({sid:s}),[o,v]=e.useState(0),m=c==="loading"?"loading":u?"hasNextPage":"end",b=e.useMemo(()=>G.orderBy([...r,...l].filter(Boolean),f=>De(f),"asc"),[l,r]),C=G.first(b),M=G.last(b);return e.useEffect(()=>{const f=t.current;f&&u&&f.scrollHeight>o&&(f.scrollTop=f.scrollHeight-o,v(f.scrollHeight))},[C,u,o]),e.useEffect(()=>{const f=t.current;f&&(f.scrollTop=f.scrollHeight)},[s,i]),e.useEffect(()=>{const f=t.current;f!=null&&f.scrollTo&&f.scrollTo({behavior:"smooth",top:f.scrollHeight})},[M]),p?n(Dt,{"data-test":"MessageList-SpinnerContainer",children:n(Ve,{"data-test":"MessageList-Spinner"})}):n(ve,{ref:t,onFetchMore:d,status:m,paddingTop:m==="hasNextPage"?"30px":"0px",scrollbarWidth:0,reverse:!0,grow:!0,"data-test":"MessageList-Infinite",children:b.map((f,x)=>We(f)?n(Bt,{message:f,prev:b[x-1],next:b[x+1],sameTypeNext:h?b[x+1]:ae((a==null?void 0:a._id)||"",b,x),"data-test":"MessageList-PendingMessageItem"},f.attributes.id):n(Et,{message:f,prev:ne(b,x,"prev"),next:ne(b,x,"next"),sameTypeNext:ae((a==null?void 0:a._id)||"",b,x),"data-test":"MessageList-MessageItem"},f.sid))})},Vt=P.div`
  display: flex;
  flex-direction: row;
  align-items: center;
  width: 100%;
  height: 86px;
  border-bottom: 1px solid var(--bg-separator-neutral-default);
  padding: 20px 4px;
  box-sizing: border-box;
  &:hover {
    cursor: pointer;
    background-color: var(--bg-tablecell-neutral-hover);
  }
`,Wt=P.div`
  display: flex;
  flex-direction: row;
  flex: 1;
  justify-content: space-between;
  align-items: center;
  padding-left: 16px;
`,Rt=P.div`
  display: flex;
  flex-direction: column;
`,Ht=P(D)``,jt=({users:t,isOpen:a,onClose:s,onGoHomeNoum:h})=>{const{isUnregistered:r}=R(),{t:l}=j(),i=p=>{s(),r||h(p)};return U(Re,{testId:"conversation-user-modal",open:a,onClose:s,enableCloseButton:!0,size:He.L,disableBackdropClick:!0,"data-test":"ConversationUserModal-Modal",children:[n(je,{"data-test":"ConversationUserModal-ModalHeader",children:l("noumena.message.chat_memebers")}),n(Ge,{mobileFlex:!0,noFooter:!0,"data-test":"ConversationUserModal-ModalBody",children:t.map((p,c)=>U(Vt,{onClick:()=>i(p),"data-testid":`conversation-user-item-${c}`,children:[n(F,{url:p.source||"","data-test":"ConversationUserModal-Avatar"}),n(Wt,{children:U(Rt,{children:[U(D,{font:"body-l-bold",colorToken:"--text-tablecell-header-neutral-highlighted","data-test":"ConversationUserModal-TSpan",children:[p.firstName," ",p.lastName]}),!!p.title&&n(Ht,{font:"body-m",colorToken:"--text-tablecell-body-neutral-default",children:p.title})]})})]},p._id))})]})},Gt=P(z).attrs(t=>({...t,align:"center",fullWidth:!0}))`
  overflow: hidden;
`,Ft=P(z).attrs(t=>({...t,align:"center",fullWidth:!0}))`
  cursor: pointer;
`,$t=P(z).attrs(t=>({...t,vertical:!0}))`
  flex: 1;
  overflow: hidden;
`,zt=({isConversationBlocked:t,users:a,title:s})=>{const[h,r]=e.useState(!1),l=e.useMemo(()=>{if(a.length===1)return a[0].title},[a]),i=e.useMemo(()=>a.map(o=>o.source),[a]),p=e.useMemo(()=>{if(i&&i.length===1)return n(F,{"data-testid":"avatar-testid",url:i[0],size:"M","data-test":"ConversationProfileView-avatar-Avatar"});if(i&&i.length===2)return n(de,{"data-testid":"diagonalavatar-testid",urls:i,size:"M","data-test":"ConversationProfileView-avatar-DiagonalAvatar2"});if(i&&i.length>2)return n(ue,{"data-testid":"diagonalavatar3-testid",urls:i,size:"M","data-test":"ConversationProfileView-avatar-DiagonalAvatar3"})},[i]),c=e.useCallback(d=>{const{userStatus:o,homeNoumId:v}=d;o===Fe.Active&&v&&window.open(`/noum/${v}`,"_blank")},[]),u=e.useCallback(()=>{a.length===1?c(a[0]):r(!0)},[c,a]);return U($,{children:[n(Gt,{"data-testid":"receiverprofile","data-test":"ConversationProfileView-ProfileWrapper",children:U(Ft,{onClick:u,"data-test":"ConversationProfileView-ProfileInfo",children:[p,n($e,{width:16,"data-test":"ConversationProfileView-Spacer"}),!t&&U($t,{"data-test":"ConversationProfileView-ProfileTitle",children:[n(D,{font:"body-m-bold",overflow:"ellipsis",colorToken:"--text-tablecell-header-neutral-highlighted","data-test":"ConversationProfileView-TSpan",children:s}),n(D,{font:"footnote",colorToken:"--text-tablecell-body-neutral-default","data-test":"ConversationProfileView-TSpan",children:l})]})]})}),n(jt,{users:a,isOpen:h,onClose:()=>{r(!1)},onGoHomeNoum:c,"data-test":"ConversationProfileView-ConversationUserModal"})]})},ls=()=>{const{activeConversationSid:t}=e.useContext(H),{title:a,users:s,isConversationBlocked:h}=A.useConversationDetails({sid:t});return n(zt,{isConversationBlocked:h,users:s,title:a,"data-test":"ConversationProfile-ConversationProfileView"})},Qt=({data:t,multiselect:a,onRemove:s})=>n(ze,{"data-testid":"selected-user",multiselect:a,"data-test":"MessageSelectedUser-SelectedUser",children:n(Qe,{avatar:n(F,{url:Ce.getProfilePicture(t.value)||void 0,size:"S","data-test":"MessageSelectedUser-Avatar"}),rightIcon:a?n(X,{"data-testid":"remove-button",name:"close_m",size:15,color:"--icon-tag-neutral",onClick:()=>s(t.value),"data-test":"MessageSelectedUser-Icon"}):void 0,"data-test":"MessageSelectedUser-Tag",children:n(D,{"data-testid":"text-message",flex:1,font:"body-m",colorToken:"--text-tag-neutral-default","data-test":"MessageSelectedUser-TSpan",children:t.label})})}),Jt=({options:t,multiselect:a,activeItem:s,loading:h,hasMore:r,onSelect:l,onFetchMore:i})=>{const{width:p}=Je(),c=h?"loading":r?"hasNextPage":"end",u=e.useMemo(()=>p<768?a:!1,[a,p]);return n(Ye,{"data-test":"MessageUserOptionRenderer-OptionRendererWrapper",children:n(ve,{"data-testid":"users-list",status:c,paddingBottom:c!=="end"?"30px":"0px",onFetchMore:i,"data-test":"MessageUserOptionRenderer-Infinite",children:t.map(d=>d.type==="value"?U(Ze,{active:(s==null?void 0:s.key)===d.key,tabIndex:0,onClick:()=>l(d),"data-test":"MessageUserOptionRenderer-DropdownItemLayout",children:[U(Ke,{selected:(s==null?void 0:s.key)===d.key,"data-test":"MessageUserOptionRenderer-DropDownLabel",children:[n(qe,{"data-test":"MessageUserOptionRenderer-AvatarWrapper",children:n(F,{url:Ce.getProfilePicture(d.value)||void 0,size:"M","data-test":"MessageUserOptionRenderer-Avatar"})}),U(Xe,{"data-test":"MessageUserOptionRenderer-DropdownValueWrapper",children:[n(et,{"data-test":"MessageUserOptionRenderer-DropdownValueLabel",children:d.label}),U(z,{gap:3,"data-test":"MessageUserOptionRenderer-Stack",children:[d.description&&n(tt,{"data-test":"MessageUserOptionRenderer-DropdownValueDescription",children:d.description}),d.value.userType===st.Noumena&&n(at,{"data-test":"MessageUserOptionRenderer-TagLabel",children:xt("noumena.message.noumena.employees")})]})]})]}),u&&n(nt,{"data-testid":"user-checkbox","data-test":"MessageUserOptionRenderer-CheckboxWrapper",children:n(ot,{isChecked:d.selected??!1,icon:n(X,{name:"tick_m",size:d.selected?24:0,color:"--icon-checkbox-neutral-alt-default","data-test":"MessageUserOptionRenderer-Icon"}),"data-test":"MessageUserOptionRenderer-Checkbox"})})]},d.key):null)})})},Yt=e.forwardRef(({inputProps:t,cancellable:a=!0,hasSelectedOption:s=!1,onCancel:h,children:r},l)=>{const{t:i}=j(),[p,c]=e.useState(!0),u=e.useRef(null);e.useEffect(()=>{if(p){const m=setTimeout(()=>{var b;(b=u.current)==null||b.focus(),clearTimeout(m)},100)}},[p,u]);const d=e.useCallback(m=>{t.onFocus&&t.onFocus(m),c(!0)},[t]),o=e.useCallback(()=>{c(!0)},[]),v=e.useCallback(m=>{t.onBlur&&t.onBlur(m),c(!1)},[t]);return U(rt,{"data-testid":"user-search",ref:l,"data-test":"MessageUserSearch-SearchWrapper",children:[U(it,{focused:p,onClick:o,"data-test":"MessageUserSearch-SearchContainer",children:[r,n(lt,{focused:p||!s,"data-test":"MessageUserSearch-InputWrapper",children:n(ct,{ref:u,...t,onFocus:d,onBlur:v,"data-test":"MessageUserSearch-InputField"})})]}),a&&n(dt,{"data-test":"MessageUserSearch-ButtonWrapper",children:n(ut,{"data-testid":"cancel-button",textOnly:!0,onClick:h,"data-test":"MessageUserSearch-Button",children:i("noumena.cancel")})})]})}),re=t=>t.map(a=>({key:a._id,label:ft(a.firstName,a.middleName,a.lastName),type:"value",description:a.title||void 0,value:a})),Zt=e.forwardRef(({data:t,initialValue:a,onSelectUsers:s,initLoading:h,loading:r,hasMore:l,onFetchMore:i,CustomOptionsContent:p,onSetSearch:c,multiselect:u=!0},d)=>{var ee;const{t:o}=j(),{conversationType:v,setIsNewConversation:m}=e.useContext(W),b=Y(),C=e.useMemo(()=>b===Z.MOBILE,[b]),M=e.useRef(null),f=C?`calc(100% - ${(((ee=M.current)==null?void 0:ee.clientHeight)||0)+180}px)`:"250px",[x,S]=e.useState(),[w,T]=e.useState(!1);e.useLayoutEffect(()=>{var k;w&&S(C?"100vw":`${((k=M.current)==null?void 0:k.scrollWidth)??0}px`)},[C,w]);const[y,E]=e.useState(),I=e.useMemo(()=>y==null?void 0:y.map(k=>k._id),[y]),[O,g]=e.useState("");e.useEffect(()=>c==null?void 0:c(O),[c,O]),e.useEffect(()=>{const k=setTimeout(()=>{T(!0)},200);return()=>{clearTimeout(k)}},[]),e.useEffect(()=>()=>{T(!1)},[]),e.useEffect(()=>{y===void 0&&E(a||[])},[a,y]),e.useEffect(()=>{y&&s(y)},[s,y]);const _=e.useMemo(()=>C&&u?!!O:!0,[u,O,C]),V=e.useMemo(()=>re(t),[t]),Q=e.useMemo(()=>{const k=[];return V.forEach(L=>{C?k.push({...L,selected:(I||[]).includes(L.key)}):(I||[]).includes(L.key)||k.push({...L,selected:!1})}),k},[V,C,I]),N=e.useMemo(()=>re(y||[]),[y]),xe=e.useMemo(()=>[J.GLOBAL_ALL,J.GLOBAL_DIRECT,J.GLOBAL_NOUM].includes(v),[v]),K=e.useCallback(()=>{g(""),E([]),T(!1),m(!1)},[m]),we=e.useCallback(k=>{const{value:L}=k.target;T(!0),g(L)},[]),Se=e.useCallback(k=>{const L=y||[];u?L.map(B=>B._id).includes(k.key)?E(L.filter(B=>B._id!==k.key)):E([...L,k.value]):E([k.value]),g("")},[u,y]),ye=e.useCallback(k=>{E(L=>(L||[]).filter(B=>B._id!==k._id))},[]);return e.useImperativeHandle(d,()=>({cancel(){K()}}),[K]),n(gt,{"data-testid":"users-picker",ref:M,"data-test":"MessageUserPicker-Container",children:n(pt,{hideIcons:!0,isLoading:h,isOpen:w,onOpen:()=>T(!0),onClose:()=>T(!1),closeOnSelect:_,multiselect:u,placement:"bottom-start",options:Q,onSelectOption:Se,usePortal:!1,isAnimation:!1,usePopStyle:!0,containerWidth:x,containerStyle:{maxHeight:f},noAvailableOptions:!V||V.length===0,noAvailableOptionsText:o("noumena.dropdown.no_users_searched.text"),noSearchOptionsText:o("noumena.dropdown.no_search_results.text"),optionsRenderer:(k,L,B)=>p||U($,{children:[k.length&&xe?n(ht,{colorToken:"--text-body-neutral-default",font:"footnote","data-test":"MessageUserPicker-UserSearchDropDownInfobox",children:"Create a direct conversation. To create a Noum conversation, visit the Noum Page."}):null,n(Jt,{loading:r,hasMore:l,options:k,multiselect:u,activeItem:B,onSelect:L,onFetchMore:i,"data-test":"MessageUserPicker-MessageUserOptionRenderer"})]}),"data-test":"MessageUserPicker-Dropdown",children:({inputProps:k,inputRef:L})=>n(Yt,{ref:L,inputProps:{...k,autoFocus:!0,placeholder:y!=null&&y.length?"":o(C?"noumena.message.user_select_placeholder_mobile":"noumena.message.user_select_placeholder"),value:O,onChange:we},hasSelectedOption:!!(y!=null&&y.length||O)||!1,onCancel:K,"data-test":"MessageUserPicker-MessageUserSearch",children:N.map(B=>n(Qt,{multiselect:!0,data:B,onRemove:ye,"data-test":"MessageUserPicker-MessageSelectedUser"},B.key))})})})}),cs=e.forwardRef((t,a)=>{var x,S;const{user:s}=R(),h=Y(),{selectedUsers:r,setSelectedUsers:l}=e.useContext(be),[i,p]=e.useState(""),{data:c,fetchMore:u,loading:d,networkStatus:o}=vt({fetchPolicy:"cache-and-network",variables:{search:i,offset:0,limit:h===Z.MOBILE?Ct:bt,activeUserOnly:!0}}),v=ce((S=(x=c==null?void 0:c.allUsers)==null?void 0:x.data)==null?void 0:S.filter(w=>(w==null?void 0:w._id)!==(s==null?void 0:s._id))),m=e.useMemo(()=>{var w;return((w=c==null?void 0:c.allUsers)==null?void 0:w.count)||0},[c]),b=e.useRef(null),C=e.useCallback(async()=>{u({variables:{offset:v.length}})},[u,v.length]),M=e.useCallback(w=>{l(w)},[l]),f=e.useCallback(()=>{var w,T;(T=(w=b==null?void 0:b.current)==null?void 0:w.cancel)==null||T.call(w)},[b]);return e.useImperativeHandle(a,()=>({cancel(){f()}}),[f]),n(z,{align:"center",fullWidth:!0,"data-testid":"newhomeconversation","data-test":"NewHomeConversationUserSelector-Stack",children:n(Zt,{ref:b,data:v,initialValue:r,onSelectUsers:M,initLoading:d&&!v.length,loading:d&&o===wt.fetchMore,hasMore:v.length<m,onFetchMore:C,onSetSearch:p,"data-test":"NewHomeConversationUserSelector-MessageUserPicker"})})});export{It as A,ns as B,os as C,Et as M,be as N,Nt as T,At as a,as as b,Tt as c,me as d,Me as e,rs as f,is as g,Zt as h,cs as i,zt as j,ls as k,Xt as l,ss as m,es as n,ts as o};
//# sourceMappingURL=NewHomeConversationUserSelector-1a2609b0.js.map
