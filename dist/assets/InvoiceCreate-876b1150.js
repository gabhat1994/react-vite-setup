import{f as tt,aP as at,m as ee,T as D,x as h,j as e,y as Se,c,M as G,h as be,i as ge,aQ as W,k as Fe,B as y,X as V,I as P,aR as le,F as N,q as ot,aS as nt,Y as ce,t as ye,v as xe,aT as it,aU as rt,aV as dt,aC as lt,aW as ct,n as Ce,aX as ve,aY as st,aZ as Oe,a_ as ut,a$ as mt,b0 as It,b1 as pt,b2 as We,b3 as Pe,R as Q,b4 as ht,b5 as vt,b6 as Ve,b7 as ft,aF as St}from"./index-cd84bcc9.js";import{g as $e,D as bt,a as gt}from"./DeleteDraftModal-e41d0b22.js";import{A as Ft}from"./useUpdateNoumContact-9e0e7edc.js";import{r as C,C as k,bb as L,l as R,ap as qe,aq as He,bD as je,be as Qe,bE as U,N as ze,b3 as te,ba as Ne,a9 as se,bc as Me,b2 as Te,aa as Ge,bz as yt}from"./vendor-51460554.js";import"./ApiEntityPickerField-cfd6d0d6.js";import{I as xt}from"./Infobox-cf6af02b.js";import{S as ne}from"./SelectField-54706174.js";import{u as Ct,P as Mt,a as Tt}from"./PdfPreviewThumbnail-3547d9fe.js";import{C as Le,m as ue,a as me}from"./contactMapper-463fcf05.js";import{n as Ye,g as K}from"./forms-18e3c53a.js";import{I as Dt,i as Xe,u as wt,a as kt,b as Et}from"./InvoiceSecretNoumAlertModal-f1c02a3f.js";import{L as Ie,D as Be}from"./types-3fb18ef5.js";import{I as T}from"./invoice-e39dbdbc.js";import{F as _,I as Pt,S as Ae}from"./styles-2c16e7fb.js";import{E as fe}from"./EllipsisMenu-8495dca0.js";import{U as zt}from"./UploadMedia-5fe81e87.js";import{b as Nt}from"./utils-da9c4d96.js";import{I as Lt,a as De,u as Bt}from"./useInvoicePdfDownload-84ddf906.js";import{g as _e}from"./contactDetails-4902172b.js";import{I as ie,u as At}from"./useInvoice-3a46c6ed.js";import{S as Ze}from"./StickyFormHeader-043ef98d.js";import{u as _t}from"./contactNoumConnection-819cdc27.js";import{u as Rt}from"./navigation-419d637e.js";import{F as Ut}from"./index-af3e0302.js";import"./Flag-d41fef47.js";import"./countries-4aa86a38.js";import"./utils-87d126b1.js";import"./Modal-5a254f40.js";import"./index-1f4ed9fc.js";import"./styles-46bbc451.js";import"./index-4963229a.js";import"./useResizeObserver-0deb9469.js";import"./SecretNoumAlertModal-f376a2a7.js";import"./Accordion-ea03839b.js";import"./index-38931f83.js";import"./ChamberLeftSideBar-2a7f8e7f.js";import"./index-2d186805.js";import"./sideNavItems-22800105.js";import"./styles-b4894a1f.js";import"./styles-d2f9f396.js";function Je(){var o,n;const{user:t}=tt(),{data:a}=at({variables:{filter:{userIds:[(t==null?void 0:t._id)??""]}},skip:!(t!=null&&t._id)});return(n=(o=a==null?void 0:a.getUserOwnedContacts)==null?void 0:o.data)==null?void 0:n.find(d=>(d==null?void 0:d.userId._id)===(t==null?void 0:t._id))}function q(){return C.useContext(Dt)}const Ot=k.table`
  width: 100%;
  border-collapse: collapse;
`,Wt=k.tbody``,Vt=k.tr`
  @media (max-width: ${ee.MOBILE_L_MAX}) {
    border-bottom: solid 1px var(--border-card-neutral-default);
  }
`,$t=k.td`
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid var(--border-card-neutral-default);
  ${t=>t.fitContents?"width: 1px":""};

  @media (max-width: ${ee.TABLET_MAX}) {
    padding: 12px 4px;
  }

  @media (max-width: ${ee.MOBILE_L_MAX}) {
    padding: 8px 0 16px;
  }
`,qt=k(D)`
  color: var(--text-card-neutral-highlighted);
`,Ht=k(D).attrs({font:"footnote",colorToken:"--text-card-neutral-default"})``,jt=k(h).attrs({fullWidth:!0,justify:"space-between",align:"center",padding:"4px 12px 4px 0"})``,Qt=k.div`
  width: ${t=>t.fullSize?"100%":"50%"};
`,E={Table:Ot,TableBody:Wt,TableRow:Vt,TableCell:$t,SummaryText:qt,ItemDetailsRow:jt,ItemDetailsRowText:Ht,SelectFieldWrapper:Qt},A=({name:t,label:a,control:o,numberOnly:n,withValidation:d,...l})=>e(L,{name:t,control:o,render:({field:i,fieldState:r})=>e(Se,{fullWidth:!0,inputSize:"small",label:a,error:!!r.error,numberOnly:n,...n?Ye.fieldProps(i):{value:i.value,onChange:i.onChange},...d?{...K(r)}:{},...l,"data-test":"FormTextField-TextField"}),"data-test":"FormTextField-Controller"}),Gt=({onSave:t,onCancel:a,totalValue:o,control:n,isValid:d,currency:l})=>c(G,{open:!0,isFullScreen:!0,onClose:a,disableBackdropClick:!0,"data-test":"InvoiceItemFormModal-Modal",children:[e(be,{isFullScreen:!0,"data-test":"InvoiceItemFormModal-ModalHeader",children:"Add item"}),c(ge,{isFullScreen:!0,"data-test":"InvoiceItemFormModal-ModalBody",children:[e(D,{font:"body-m-bold",colorToken:"--text-card-neutral-highlighted","data-test":"InvoiceItemFormModal-TSpan",children:"Item Details"}),c(h,{gap:12,padding:"16px 0",vertical:!0,fullWidth:!0,"data-test":"InvoiceItemFormModal-Stack",children:[e(A,{control:n,name:"description",label:"Description","data-test":"InvoiceItemFormModal-FormTextField"}),e(A,{control:n,name:"quantity",label:"Quantity","data-test":"InvoiceItemFormModal-FormTextField"}),e(A,{name:"unitPrice",label:"Unit Price",isCurrency:!0,numberOnly:!0,control:n,prefix:$e(l),hideLeftIconPlace:!0,"data-test":"InvoiceItemFormModal-FormTextField"}),e(A,{name:"taxRate",label:"Tax",numberOnly:!0,control:n,suffix:"%",hideLeftIconPlace:!0,"data-test":"InvoiceItemFormModal-FormTextField"})]}),e(h,{padding:"16px 0 0","data-test":"InvoiceItemFormModal-Stack",children:e(D,{font:"body-l-bold","data-test":"InvoiceItemFormModal-TSpan",children:W(o,l,2)})})]}),e(Fe,{isFullScreen:!0,"data-test":"InvoiceItemFormModal-ModalFooter",children:c(h,{gap:16,fullWidth:!0,"data-test":"InvoiceItemFormModal-Stack",children:[e(y,{softDisabled:!d,size:"full",tertiary:!0,onClick:()=>t(!0),"data-test":"InvoiceItemFormModal-Button",children:"Save & Add Another"}),e(y,{softDisabled:!d,size:"full",primary:!0,onClick:()=>t(!1),"data-test":"InvoiceItemFormModal-Button",children:"Save"})]})})]}),Yt=k(h)`
  border-radius: 8px;
  padding: 16px;
  border: solid 1px
    ${t=>t.hasError?"var(--border-input-danger-primary-default)":"var(--border-input-neutral-default)"};
`,Xt={Container:Yt},Ke=({onSave:t,onCancel:a,onDelete:o,values:n,currency:d,mode:l})=>{const[i,r]=C.useState(R.isNumber(n==null?void 0:n.taxRate)),{watch:u,handleSubmit:v,formState:{isValid:m,errors:S},resetField:f,control:x}=qe({defaultValues:n,mode:"all",resolver:He(je(Xe,"lineItems.0"))}),{isMobile:F}=V(),g=Object.keys(S).length>0,b=O=>{v(z=>{t({item:{...z,taxName:z.taxName&&R.isNumber(z.taxRate)?z.taxName:void 0,taxRate:z.taxName&&R.isNumber(z.taxRate)?z.taxRate:void 0},createAnother:O})})()},p=u("quantity"),s=u("unitPrice"),M=u("taxRate"),w=u("taxName"),I=T.getItemTotalValue(p,s,M);return F?e(Gt,{totalValue:I,control:x,isValid:m,onCancel:a,onSave:b,currency:d,"data-test":"InvoiceItemForm-InvoiceItemFormModal"}):e(Xt.Container,{fullWidth:!0,hasError:g,children:e(_,{title:"Item details",font:"body-l-bold",sectionSeparator:!1,fullSize:!0,rightIcon:e(D,{font:"body-l",color:"--text-card-neutral-highlighted","data-test":"InvoiceItemForm-TSpan",children:W(Number.isNaN(I)?0:I,d,2)}),"data-test":"InvoiceItemForm-FormSection",children:c(h,{fullWidth:!0,vertical:!0,gap:16,padding:"12px 0 0","data-test":"InvoiceItemForm-Stack",children:[c(h,{vertical:!0,padding:"0 0 16px",fullWidth:!0,"data-test":"InvoiceItemForm-Stack",children:[c(h,{gap:12,fullWidth:!0,"data-test":"InvoiceItemForm-Stack",children:[c(h,{vertical:!0,gap:12,fullWidth:!0,"data-test":"InvoiceItemForm-Stack",children:[e(A,{control:x,name:"description",label:"Description","data-test":"InvoiceItemForm-FormTextField"}),i?c(h,{gap:12,fullWidth:!0,"data-test":"InvoiceItemForm-Stack",children:[e(A,{name:"taxName",label:"Tax Name",control:x,"data-test":"InvoiceItemForm-FormTextField"}),e(A,{name:"taxRate",label:"Tax Rate",isCurrency:!0,numberOnly:!0,control:x,suffix:"%",disabled:!w,"data-test":"InvoiceItemForm-FormTextField"}),e(y,{size:"small",intent:"negative",secondary:!0,onClick:()=>{f("taxRate",{defaultValue:null,keepError:!1,keepDirty:!1}),f("taxName",{defaultValue:null,keepError:!1,keepDirty:!1}),r(!1)},icon:e(P,{name:"delete_m",size:24,"data-test":"InvoiceItemForm-Icon"}),"data-test":"InvoiceItemForm-Button"})]}):e(y,{size:"small",neutral:!0,onClick:()=>r(!0),leftIcon:e(P,{name:"add_m",size:24,color:"--text-button-brand-primary-default","data-test":"InvoiceItemForm-Icon"}),"data-test":"InvoiceItemForm-Button",children:e(D,{font:"button-m",colorToken:"--text-button-brand-primary-default","data-test":"InvoiceItemForm-TSpan",children:"Add tax"})})]}),c(h,{gap:12,align:"center","data-test":"InvoiceItemForm-Stack",children:[e(A,{control:x,name:"quantity",numberOnly:!0,integerOnly:!0,label:"Quantity","data-test":"InvoiceItemForm-FormTextField"}),e(A,{name:"unitPrice",label:"Unit Price",isCurrency:!0,numberOnly:!0,prefix:$e(d),control:x,"data-test":"InvoiceItemForm-FormTextField"})]})]}),g&&e(h,{padding:"0 0 0 8px","data-test":"InvoiceItemForm-Stack",children:e(D,{font:"footnote",colorToken:"--text-input-danger-primary-default","data-test":"InvoiceItemForm-TSpan",children:"Please provide missing information."})})]}),c(h,{justify:"flex-end",fullWidth:!0,gap:12,"data-test":"InvoiceItemForm-Stack",children:[e(y,{size:"small",neutral:!0,onClick:a,"data-test":"InvoiceItemForm-Button",children:"Cancel"}),l==="edit"?e(y,{size:"small",intent:"negative",secondary:!0,onClick:o,"data-test":"InvoiceItemForm-Button",children:"Delete"}):e(y,{softDisabled:!m,size:"small",tertiary:!0,onClick:()=>b(!0),"data-test":"InvoiceItemForm-Button",children:"Save & Add Another"}),e(y,{softDisabled:!m,size:"small",primary:!0,onClick:()=>b(!1),"data-test":"InvoiceItemForm-Button",children:"Save"})]})]})})})},Zt=({data:t,index:a,currency:o,onSave:n,onCancel:d,onDelete:l})=>{const i=({item:u})=>{n(a,u)},r=()=>{l(a)};return e(E.TableRow,{children:e("td",{colSpan:4,"data-test":"EditMode-td",children:e(Ke,{mode:"edit",values:t,onCancel:d,onDelete:r,onSave:i,currency:o,"data-test":"EditMode-InvoiceItemForm"})})})},Jt=({isOpenModal:t,onClose:a,onConfirm:o})=>e(G,{isFullScreen:!1,open:t,testId:"delete_line_item_modal",onClose:a,disableBackdropClick:!0,"data-test":"DeleteLineItemModal-Modal",children:c(h,{gap:16,padding:14,vertical:!0,maxWidth:327,align:"center",justify:"center","data-test":"DeleteLineItemModal-Stack",children:[e(D,{font:"heading-s-bold",colorToken:"--text-modal-header-neutral-default","data-test":"DeleteLineItemModal-TSpan",children:"Delete Item"}),c(D,{"data-testid":"confirm_text",font:"body-l",textAlign:"center",colorToken:"--text-modal-neutral-default","data-test":"DeleteLineItemModal-TSpan",children:["Are you sure you want to permanently delete this item?",e("br",{})," ",e("br",{}),"This cannot be undone."]}),c(h,{vertical:!0,gap:16,fullWidth:!0,padding:"12px 0 0","data-test":"DeleteLineItemModal-Stack",children:[e(y,{primary:!0,size:"full",testId:"confirm_btn",intent:"negative",grow:!0,onClick:o,"data-test":"DeleteLineItemModal-Button",children:"Delete Item"}),e(y,{tertiary:!0,onClick:a,size:"full",testId:"cancel_btn","data-test":"DeleteLineItemModal-Button",children:"Close"})]})]})}),Re=[{key:"edit",value:"edit",label:"Edit Item",type:"value",icon:e(P,{name:"edit_m",size:16,"data-test":"tableItemContextMenuOptions-Icon"})},{key:"delete",value:"delete",label:"Delete Item",type:"value",icon:e(P,{name:"delete_m",color:"--icon-tablecell-danger-primary-default",size:16,"data-test":"tableItemContextMenuOptions-Icon"}),intent:"danger"}],Kt=({data:t,onDelete:a,onEdit:o,index:n,currency:d})=>{const{isMobile:l}=V(),{openModal:i,closeModal:r,modalType:u}=le(),v=m=>{switch(m){case"edit":o(n);break;case"delete":i("deleteItem");break}};return c(N,{children:[l?e(E.TableRow,{children:c(E.TableCell,{children:[c(h,{fullWidth:!0,justify:"space-between",align:"center","data-test":"PreviewMode-Stack",children:[e(D,{font:"body-m-bold",colorToken:"--text-card-neutral-highlighted","data-test":"PreviewMode-TSpan",children:t.description}),e(fe,{neutral:!0,onClick:m=>v(m),menuOptions:Re,"data-test":"PreviewMode-EllipsisMenu"})]}),c(E.ItemDetailsRow,{children:[e(E.ItemDetailsRowText,{children:"Quantity:"}),e(E.ItemDetailsRowText,{children:t.quantity})]}),c(E.ItemDetailsRow,{children:[e(E.ItemDetailsRowText,{children:"Unit Price:"}),e(E.ItemDetailsRowText,{children:t.unitPrice})]}),c(E.ItemDetailsRow,{children:[e(E.ItemDetailsRowText,{children:"Tax Rate:"}),e(E.ItemDetailsRowText,{children:R.isNumber(t.taxRate)?t.taxRate:"-"})]}),c(E.ItemDetailsRow,{children:[e(E.ItemDetailsRowText,{children:"Amount:"}),e(E.ItemDetailsRowText,{children:T.getItemTotalValueWithCurrency(t.quantity,t.unitPrice,t.taxRate,d)})]})]})}):c(E.TableRow,{children:[e(E.TableCell,{fitContents:!1,children:c(D,{font:"body-m",colorToken:"--text-card-neutral-highlighted","data-test":"PreviewMode-TSpan",children:[t.description," x ",t.quantity]})}),e(E.TableCell,{fitContents:!0,children:R.isNumber(t.taxRate)?e(D,{font:"body-m",colorToken:"--text-card-neutral-highlighted","data-test":"PreviewMode-TSpan",children:c(ot,{tertiary:!0,size:"small","data-test":"PreviewMode-Tag",children:[t.taxRate,"% tax"]})}):null}),e(E.TableCell,{fitContents:!0,children:e(D,{font:"body-m",colorToken:"--text-card-neutral-highlighted","data-test":"PreviewMode-TSpan",children:W(t.unitPrice,d,2)})}),e(E.TableCell,{fitContents:!0,children:e(fe,{neutral:!0,onClick:m=>v(m),menuOptions:Re,"data-test":"PreviewMode-EllipsisMenu"})})]}),e(Jt,{isOpenModal:u==="deleteItem",onConfirm:()=>a(n),onClose:()=>r(),"data-test":"PreviewMode-DeleteLineItemModal"})]})};function ea(){const{fields:t,addNewItem:a,cancelItemEditing:o,deleteItem:n,editItem:d,editedIndex:l,hideNewItemForm:i,mode:r,saveItem:u,showNewItemForm:v}=Ct({name:"lineItems"}),m=Qe(),[S]=nt({onCompleted:()=>{m.refetchQueries({include:["getUserInvoiceLineItemList"]})}}),{logError:f}=ce();return{mode:r,editedIndex:l,fields:t,showNewItemForm:v,hideNewItemForm:i,addNewItem:async(F,g)=>{if(!g){a(F);return}try{await S({variables:{input:{description:F.description,quantity:F.quantity,currency:F.currency,unitPrice:F.unitPrice,taxRate:F.taxRate,taxLabel:F.taxName}}}),a(F)}catch(b){f(b,"useInvoiceItemsWizard")}},deleteItem:n,cancelItemEditing:o,saveItem:u,editItem:d}}const ta=({isOpenModal:t,item:a,onClose:o,onConfirm:n})=>{const{isMobile:d}=V(),{handleSubmit:l,control:i,watch:r,resetField:u}=qe({defaultValues:{id:a==null?void 0:a.id,description:a==null?void 0:a.description,unitPrice:a==null?void 0:a.unitPrice,taxRate:(a==null?void 0:a.taxRate)??0,quantity:a==null?void 0:a.quantity,currency:a==null?void 0:a.currency,taxName:(a==null?void 0:a.taxLabel)??void 0},mode:"all",resolver:He(je(Xe,"lineItems.0"))}),[v,m]=C.useState(()=>R.isNumber(a==null?void 0:a.taxRate)),S=()=>{l(f=>{n(f)})()};return c(G,{isFullScreen:d,open:t,testId:"add_new_customer_modal",size:ye.L,onClose:o,isScrollableContent:!0,disableBackdropClick:!0,"data-test":"EditModal-Modal",children:[e(be,{action:e(y,{tertiary:!0,onClick:o,size:"small",icon:e(P,{name:"arrow_left_m",size:24,"data-test":"EditModal-Icon"}),"data-test":"EditModal-Button"}),"data-test":"EditModal-ModalHeader",children:"Edit Item"}),e(ge,{hasScrollBar:!0,"data-test":"EditModal-ModalBody",children:c(h,{gap:16,padding:"8px 0 0",vertical:!0,fullWidth:!0,"data-test":"EditModal-Stack",children:[e(A,{control:i,label:"Description",name:"description",inputSize:"small",withValidation:!0,"data-test":"EditModal-FormTextField"}),e(A,{control:i,label:"Unit Price",name:"unitPrice",numberOnly:!0,isCurrency:!0,hideLeftIconPlace:!0,inputSize:"small",withValidation:!0,"data-test":"EditModal-FormTextField"}),v?c(h,{fullWidth:!0,gap:8,"data-test":"EditModal-Stack",children:[e(h,{fullWidth:!0,"data-test":"EditModal-Stack",children:e(A,{label:"Tax Name",control:i,inputSize:"small",name:"taxName",withValidation:!0,helperText:"Enter tax type (e.g. VAT)","data-test":"EditModal-FormTextField"})}),c(h,{gap:8,"data-test":"EditModal-Stack",children:[e(A,{label:"Tax",control:i,inputSize:"small",name:"taxRate",numberOnly:!0,isCurrency:!0,suffix:"%",disabled:!r("taxName"),withValidation:!0,"data-test":"EditModal-FormTextField"}),e(y,{size:"small",intent:"negative",secondary:!0,onClick:()=>{u("taxRate",{defaultValue:null,keepError:!1,keepDirty:!1}),u("taxName",{defaultValue:null,keepError:!1,keepDirty:!1}),m(!1)},icon:e(P,{name:"delete_m",size:24,"data-test":"EditModal-Icon"}),"data-test":"EditModal-Button"})]})]}):e(y,{size:"small",neutral:!0,onClick:()=>m(!0),leftIcon:e(P,{name:"add_m",size:24,color:"--text-button-brand-primary-default","data-test":"EditModal-Icon"}),"data-test":"EditModal-Button",children:e(D,{font:"button-m",colorToken:"--text-button-brand-primary-default","data-test":"EditModal-TSpan",children:"Add tax"})})]})}),e(Fe,{"data-test":"EditModal-ModalFooter",children:c(h,{fullWidth:!0,gap:16,"data-test":"EditModal-Stack",children:[e(y,{primary:!0,size:"full",testId:"confirm_btn",tertiary:!0,grow:!0,loading:!1,onClick:o,"data-test":"EditModal-Button",children:"Cancel"}),e(y,{primary:!0,size:"full",onClick:S,"data-test":"EditModal-Button",children:"Save Changes"})]})})]})},aa=({isOpenModal:t,onClose:a,onConfirm:o})=>e(G,{open:t,testId:"saved_items_delete_modal",onClose:a,size:ye.S,disableBackdropClick:!0,"data-test":"DeleteModal-Modal",children:c(h,{gap:32,padding:14,vertical:!0,align:"center",justify:"center","data-test":"DeleteModal-Stack",children:[e(D,{font:"heading-s-bold",colorToken:"--text-modal-header-neutral-default","data-test":"DeleteModal-TSpan",children:"Delete Item"}),c(D,{"data-testid":"confirm_text",font:"body-l",textAlign:"center",colorToken:"--text-modal-neutral-default","data-test":"DeleteModal-TSpan",children:["Are you sure you want to permanently delete this item?",e("br",{}),e("br",{}),"This cannot be undone."]}),c(h,{vertical:!0,fullWidth:!0,gap:16,"data-test":"DeleteModal-Stack",children:[e(y,{primary:!0,size:"full",testId:"confirm_btn",intent:"negative",grow:!0,onClick:o,"data-test":"DeleteModal-Button",children:"Delete Item"}),e(y,{tertiary:!0,onClick:a,size:"full",testId:"cancel_btn","data-test":"DeleteModal-Button",children:"Cancel"})]})]})}),oa=k(h)`
  border-bottom: solid 1px var(--border-card-neutral-default);
  padding: 8px 0;
`,na={ListItem:oa},ia=({isOpenModal:t,items:a=[],onDelete:o,onEdit:n,onClose:d})=>{const{isMobile:l}=V();return c(G,{isFullScreen:l,open:t,testId:"saved_items_list_modal",size:ye.L,onClose:d,enableCloseButton:!0,isScrollableContent:!0,disableBackdropClick:!0,"data-test":"ListModal-Modal",children:[e(be,{"data-test":"ListModal-ModalHeader",children:"Saved Products & Services"}),e(ge,{hasScrollBar:!0,"data-test":"ListModal-ModalBody",children:e(h,{gap:16,padding:14,vertical:!0,fullWidth:!0,"data-test":"ListModal-Stack",children:a.map(i=>c(na.ListItem,{align:"center",fullWidth:!0,justify:"space-between",children:[e(D,{colorToken:"--text-card-neutral-highlighted",font:"body-m-bold","data-test":"ListModal-TSpan",children:i.description}),c(h,{align:"center",gap:4,"data-test":"ListModal-Stack",children:[e(D,{font:"body-m",colorToken:"--text-card-neutral-default","data-test":"ListModal-TSpan",children:T.formatAmount(i.unitPrice.toFixed(2))}),e(y,{neutral:!0,onClick:()=>n(i.id),size:"small",icon:e(P,{name:"edit_m",color:"--icon-button-brand-primary-default",size:16,"data-test":"ListModal-Icon"}),"data-test":"ListModal-Button"}),e(y,{neutral:!0,onClick:()=>o(i.id),size:"small",icon:e(P,{name:"delete_m",size:16,color:"--icon-tablecell-danger-primary-default","data-test":"ListModal-Icon"}),"data-test":"ListModal-Button"})]})]}))})}),e(Fe,{"data-test":"ListModal-ModalFooter",children:e(h,{fullWidth:!0,gap:16,"data-test":"ListModal-Stack",children:e(y,{size:"full",tertiary:!0,loading:!1,onClick:d,"data-test":"ListModal-Button",children:"Close"})})})]})};function ra(t,a){switch(a.mode){case"delete":return{mode:"delete",editedId:a.editedId};case"preview":return{mode:"preview",editedId:null};case"edit":return{mode:"edit",editedId:a.editedId};default:return t}}const da=({isOpenModal:t,items:a,onClose:o})=>{const[{mode:n,editedId:d},l]=C.useReducer(ra,{mode:"preview",editedId:null}),i=Qe(),r=a.find(s=>s.id===d),{addPrimaryIconToast:u,addSuccessIconToast:v}=xe(),[m]=it({onCompleted:()=>{i.refetchQueries({include:["getUserInvoiceLineItemList"]})}}),[S]=rt({onCompleted:()=>{i.refetchQueries({include:["getUserInvoiceLineItemList"]})}}),{logError:f}=ce(),x=s=>{l({mode:"edit",editedId:s})},F=s=>{l({mode:"delete",editedId:s})},g=()=>{l({mode:"preview"})};return n==="edit"?e(ta,{isOpenModal:!0,onClose:g,onConfirm:async s=>{if(!r)throw Error("No edited item found.");try{await m({variables:{_id:r.id,input:{currency:s.currency,description:s.description,quantity:s.quantity,taxRate:s.taxRate,unitPrice:s.unitPrice,taxLabel:s.taxName}}}),v("Item has been edited.")}catch(M){f(M,"SavedItemsModalWizard")}g()},item:r,"data-test":"SavedItemsModalWizard-EditModal"}):n==="delete"?e(aa,{isOpenModal:!0,onClose:g,onConfirm:async()=>{if(r){try{await S({variables:{_id:r.id}}),u("Item has been deleted.")}catch(s){f(s,"SavedItemsModalWizard")}g()}},"data-test":"SavedItemsModalWizard-DeleteModal"}):t&&n==="preview"?e(ia,{isOpenModal:!0,onDelete:F,onEdit:x,onClose:o,items:a,"data-test":"SavedItemsModalWizard-ListModal"}):null},J="ADD_ONE_TIME_ITEM",j="CREATE_SERVICE_OR_PRODUCT",la=({onAdd:t,onCancel:a,onShowNewItemForm:o})=>{var b;const[n,d]=C.useState(),{watch:l,formState:{errors:i}}=U(),[r,u]=C.useState(!1),[v]=l(["currency"]),{data:m,loading:S}=dt({variables:{filter:{limit:10,offset:0,search:""}}}),f=lt((b=m==null?void 0:m.getUserInvoiceLineItemList)==null?void 0:b.data),x=C.useMemo(()=>f.map(p=>({key:p.id,label:p.description,type:"value",value:p.id})),[f]),F=C.useMemo(()=>[{type:"value",value:J,key:J,label:"Add One-Time Item",icon:e(P,{name:"add_m",size:24,"data-test":"CreateMode-stickyHeaderOptions-Icon"})},{type:"value",value:j,key:j,label:"Create New Product or Service",icon:e(P,{name:"add_m",size:24,"data-test":"CreateMode-stickyHeaderOptions-Icon"})}],[]),g=x.length?[{type:"header",label:"Your Products & Services",childLabels:["Add One-Time Item","Create New Product or Service"],rightIcon:e(y,{size:"small",neutral:!0,textOnly:!0,onClick:()=>u(!0),leftIcon:e(P,{name:"edit_m",size:16,"data-test":"CreateMode-options-Icon"}),"data-test":"CreateMode-options-Button",children:e(D,{font:"footnote-bold","data-test":"CreateMode-options-TSpan",children:"Edit"})})},...x]:[];return c(N,{children:[n!==J&&n!==j&&e(E.SelectFieldWrapper,{fullSize:!0,children:e(ne,{inputSize:"small",label:"Find or add an item...",value:n,stickyHeaderOptions:F,error:!!i.lineItems,calRefTop:!1,forceListFromBottom:!0,helperText:"You have to add at least one item",leftIcon:e(P,{name:"search_m",color:"--icon-input-neutral-default",size:20,"data-test":"CreateMode-Icon"}),isLoading:S,onChange:p=>{if(p.value===J||p.value===j){d(p.value);return}const s=f.find(M=>M.id===p.value);s&&(t({id:s.id,description:s.description,quantity:s.quantity,taxRate:s.taxRate??void 0,unitPrice:s.unitPrice,currency:s.currency,taxName:s.taxLabel??void 0}),d(p.value))},usePortal:!0,options:g,"data-test":"CreateMode-SelectField"},String(r))}),(n===J||n===j)&&e(Ke,{onCancel:()=>{a(),d(void 0)},values:{id:"NEW",quantity:0,description:"",taxRate:void 0,unitPrice:0,currency:v,taxName:""},mode:"create",currency:v,onSave:async({item:p,createAnother:s})=>{await t(p,n===j),a(),s&&o()},"data-test":"CreateMode-InvoiceItemForm"}),e(da,{items:f,isOpenModal:r,onClose:()=>u(!1),"data-test":"CreateMode-SavedItemsModalWizard"})]})},ca=()=>{const{watch:t}=U(),{fields:a,addNewItem:o,cancelItemEditing:n,deleteItem:d,editItem:l,editedIndex:i,hideNewItemForm:r,mode:u,saveItem:v,showNewItemForm:m}=ea(),{isMobile:S}=V(),[f,x,F,g]=t(["currency","lineItems","defaultTaxRate","defaultTaxName"]);return c(N,{children:[e(E.Table,{children:e(E.TableBody,{children:a.map((b,p)=>u==="edit"&&i===p?e(Zt,{index:p,data:b,onCancel:n,onDelete:d,onSave:v,currency:f,"data-test":"InvoiceItemsWizard-EditMode"},b.id):e(Kt,{index:p,data:b,onEdit:l,onDelete:d,currency:f,"data-test":"InvoiceItemsWizard-PreviewMode"},b.id))})}),(u==="create"||!a.length)&&e(la,{onAdd:o,onCancel:r,onShowNewItemForm:m,"data-test":"InvoiceItemsWizard-CreateMode"}),!!a.length&&e(N,{children:c(h,{padding:"12px 0 0 0",align:"start",justify:"space-between",fullWidth:!0,vertical:S,gap:S?16:0,"data-test":"InvoiceItemsWizard-Stack",children:[e(h,{fullWidth:!0,"data-test":"InvoiceItemsWizard-Stack",children:e(y,{size:"small",neutral:!0,onClick:()=>m(),disabled:u==="create",leftIcon:e(P,{name:"add_m",size:24,color:"--text-button-brand-primary-default","data-test":"InvoiceItemsWizard-Icon"}),"data-test":"InvoiceItemsWizard-Button",children:e(D,{font:"button-m",colorToken:"--text-button-brand-primary-default","data-test":"InvoiceItemsWizard-TSpan",children:"Add New Item"})})}),e(Pt,{lineItems:x,defaultTaxRate:F,defaultTaxName:g,currency:f,"data-test":"InvoiceItemsWizard-InvoiceSummaryTable"})]})})]})},sa=({disabled:t})=>{const{control:a,setValue:o,watch:n}=U(),{isTablet:d}=V();return c(h,{gap:8,vertical:d,"data-test":"InvoiceLateFeeField-Stack",children:[e(L,{control:a,name:"lateFeeType",render:({field:l})=>e(ne,{inputSize:"small",onChange:i=>{l.onChange(i.value),o("lateFeeValue",void 0,{shouldValidate:i.value===Ie.NO_LATE_FEE})},value:l.value,disabled:t,options:T.lateFeeOptions,usePortal:!0,renderContainerFromBottom:!0,"data-test":"InvoiceLateFeeField-SelectField"}),"data-test":"InvoiceLateFeeField-Controller"}),n("lateFeeType")!==Ie.NO_LATE_FEE&&e(L,{control:a,name:"lateFeeValue",render:({field:l,fieldState:i})=>e(Se,{inputSize:"small",label:n("lateFeeType")===Ie.FIXED_AMOUNT?"Fixed Fee":"Late Fee in %",numberOnly:!0,...Ye.fieldProps(l),...K(i),"data-test":"InvoiceLateFeeField-TextField"}),"data-test":"InvoiceLateFeeField-Controller"})]})},ua=k(h)`
  border: ${t=>t.isUploaded?" 1px solid var(--border-card-neutral-highlighted)":"none"};
  width: 100%;
  border-radius: 8px;
  padding: ${t=>t.isUploaded?"16px":"0"};
`,ma=k.img`
  width: 100%;
  height: 100%;
  max-width: 160px;
  max-height: 56px;
  object-fit: contain;
`,Ia=k.div`
  padding: 16px;
  position: relative;
`,pe={ImagePreview:ma,Container:ua,SpinnerContainer:Ia},pa=()=>{const{setValue:t,control:a,formState:{isSubmitting:o},watch:n}=U(),[d,l]=C.useState(!1),[i,r]=C.useState({name:"",type:"",size:0,extension:""}),u=S=>{r({name:S.name,type:S.type,size:S.size,extension:S.name.substring(S.name.lastIndexOf(".")+1)})},v=()=>{t("logo","",{shouldDirty:!0}),l(!1),r({name:"",type:"",size:0,extension:""})},m=!!i.name||!!n("logo");return e(pe.Container,{isUploaded:m&&!d,children:e(L,{control:a,name:"logo",defaultValue:void 0,render:({field:{value:S}})=>c(N,{children:[e(zt,{onUploading:()=>{},acceptedFileTypes:ct,maxSize:1,setMediaDetail:u,onContentChange:f=>{t("logo",f,{shouldDirty:!0})},onError:f=>{i.name&&f&&r({name:"",type:"",size:0,extension:""}),l(f)},isHidden:m&&!d,error:d,marginTop:0,keepOriginalName:!0,"data-test":"InvoiceLogoUpload-UploadMedia"}),!d&&m?c(h,{fullWidth:!0,gap:16,align:"center","data-test":"InvoiceLogoUpload-Stack",children:[S?e(pe.ImagePreview,{src:S??"",alt:""}):e(pe.SpinnerContainer,{children:e(Ce,{"data-test":"InvoiceLogoUpload-Spinner"})}),c(h,{vertical:!0,fullWidth:!0,"data-test":"InvoiceLogoUpload-Stack",children:[e(D,{font:"body-m",colorToken:"--text-card-header-neutral-highlighted","data-test":"InvoiceLogoUpload-TSpan",children:i==null?void 0:i.name}),c(D,{colorToken:"--text-card-neutral-default","data-test":"InvoiceLogoUpload-TSpan",children:[Nt(i==null?void 0:i.size)," MB"]})]}),e(y,{size:"small",tertiary:!0,disabled:!!(i!=null&&i.name)&&!S||o,icon:e(P,{name:"delete_m",size:20,color:"--button-card-neutral-default","data-test":"InvoiceLogoUpload-Icon"}),onClick:v,neutral:!0,"data-test":"InvoiceLogoUpload-Button"})]}):null]}),"data-test":"InvoiceLogoUpload-Controller"})})},ha=k(D)`
  white-space: nowrap;
`,va=k(Se).attrs({style:{backgroundColor:"var(--bg-card-neutral-alt-default)",border:"1px solid var(--border-card-neutral-highlighted)"}})``,fa=k.div`
  padding-right: 8px;
`,he={InvoiceNumberLabel:ha,TextFieldInput:va,SpinnerContainer:fa};function Sa({disabled:t}){var M;const{setValue:a,watch:o,setError:n,clearErrors:d,resetField:l}=U(),[i,r,u]=o(["id","noumId","invoiceNumber"]),v=ve(r),[m,S]=C.useState(!1);C.useEffect(()=>{v&&r&&v!==r&&S(!0)},[r,v]);const{data:f,refetch:x,loading:F}=st({variables:{noumId:r},onCompleted(w){const I=String(w.getInvoiceSequence.sequence??"");(!u||m)&&(a("invoiceNumber",I),S(!1))},skip:!r||t,fetchPolicy:"network-only"}),g=Oe(u,1e3),{loading:b}=ut({fetchPolicy:"network-only",onCompleted(w){const I=w==null?void 0:w.validateInvoiceSequence;!(I!=null&&I.success)&&(I!=null&&I.message)?n("invoiceNumber",{message:I.message,type:"pattern"}):d("invoiceNumber")},variables:{noumId:r,sequence:g||"",invoiceId:i||""},skip:!g||t}),p=C.useCallback(async()=>{const w=await x();l("invoiceNumber"),a("invoiceNumber",String(w.data.getInvoiceSequence.sequence),{shouldDirty:!0})},[x,l,a]);return{suggestedSequenceNumber:String(((M=f==null?void 0:f.getInvoiceSequence)==null?void 0:M.sequence)??""),refetch:x,loading:F||b,resetInvoiceNumber:p}}const ba=({disabled:t})=>{const{control:a,formState:{errors:o},watch:n}=U(),{loading:d,resetInvoiceNumber:l,suggestedSequenceNumber:i}=Sa({disabled:t}),{isTablet:r,isMobile:u}=V(),v=!!o.invoiceNumber&&!d,[m,S]=n(["invoiceNumber","status"]);return c(h,{gap:16,align:"center",fullWidth:!0,padding:v?"0 0 16px 0":"0","data-test":"InvoiceNumberField-Stack",children:[e(he.InvoiceNumberLabel,{font:u?"body-l-bold":"body-xl-bold",children:"Invoice No."}),c(h,{align:"center",gap:4,"data-test":"InvoiceNumberField-Stack",children:[e(L,{control:a,defaultValue:"",name:"invoiceNumber",render:({field:{value:f,onChange:x},fieldState:{error:F}})=>e(he.TextFieldInput,{value:f,onChange:x,disabled:t,inputSize:"small",error:v,helperText:v?F==null?void 0:F.message:"",label:t&&!f?"—":void 0,helperTextAbsolute:!0,maxLength:8,onlyAlphanumeric:!0,hideLengthHelperText:!0,rightIcon:d?e(he.SpinnerContainer,{children:e(Ce,{"data-test":"InvoiceNumberField-Spinner"})}):void 0}),"data-test":"InvoiceNumberField-Controller"}),!d&&!t&&m!==i&&e(y,{size:"small",icon:e(P,{name:"revert_m",size:24,"data-test":"InvoiceNumberField-Icon"}),neutral:!0,onClick:l,tooltipText:"Reset invoice number to auto-generated",tooltipPosition:r?"bottom-left":"bottom-right","data-test":"InvoiceNumberField-Button"})]}),e(Lt,{status:S,"data-test":"InvoiceNumberField-InvoiceStatusBadge"})]})},ga=t=>t?mt(t,"application/pdf"):void 0,Fa=(t,a,o)=>{var n,d,l,i;return{receiver:{address:a?[a.apartmentNo||a.street?`${a.apartmentNo??""} ${a.street??""}`:"",a.city??"",`${a.state}, ${a.zipCode}`,((n=_e(a.country))==null?void 0:n.name)??""]:[],email:null,name:a==null?void 0:a.name},sender:{address:o?[`${o.apartmentNo} ${o.street}`,o.city??"",`${o.state}, ${o.zipCode}`,((d=_e(o.country))==null?void 0:d.name)??""]:[],email:null,name:o==null?void 0:o.name},invoiceDetails:{currency:t.currency,due:t?ze(new Date(ie.serializeDueDate(t)),"dd MMM yyyy"):"",latefee:T.getLateFeeText(ie.mapFromLateFeeOption(t.lateFeeType),t.lateFeeValue,t.currency),date:t.issueDate?ze(t.issueDate,"dd MMM yyyy"):"",number:t.invoiceNumber,terms:t.paymentTerms?T.paymentTermsMap[t.paymentTerms]:"",title:""},items:(l=t.lineItems)==null?void 0:l.map(r=>({amount:W(T.getItemTotalValue(r.quantity??0,r.unitPrice??0,r.taxRate),t.currency),description:r.description,price:W(r.unitPrice||0,t.currency),quantity:String(r.quantity),tax:R.isNumber(r.taxRate)?`${r.taxRate}%`:""})),summary:{subTotal:W(R.sumBy(t.lineItems,r=>T.getItemSubtotalValue(r.quantity??0,r.unitPrice??0)),t.currency),taxes:(i=T.getTaxItems(t.lineItems||[]))==null?void 0:i.map(r=>({title:`${r.taxName} (${r.taxRate||0}%)`,value:W(r.taxSum??0,t.currency)})),total:W(T.getAllItemsTotalValue(t.lineItems),t.currency)},footer:{text:t.notes},logo:t.logo?{image:t.logo}:void 0,subject:t.summary,title:"Invoice"}},re={toBase64Data:ga,toInvoicePDFPreview:Fa},ya=(t,a)=>R.isEmpty(R.xorWith(t,a,R.isEqual));function xa({values:t,disabled:a}){const{selectedBuyer:o,selectedServiceProvider:n}=q(),d=Oe(t,4e3),l=ve(d),i=C.useMemo(()=>{const{lineItems:f=[],...x}=d??{},{lineItems:F=[],...g}=l??{};return!R.isEqual(x,g)||!ya(f,F)},[l,d]),[r,{data:u,loading:v}]=It();C.useEffect(()=>{(i||!(u!=null&&u.invoicePDFPreview))&&!v&&!a&&(t!=null&&t.noumId)&&r({variables:{data:re.toInvoicePDFPreview(t,o,n)}})},[u==null?void 0:u.invoicePDFPreview,a,r,o,v,n,i,t]);const m=re.toBase64Data(u==null?void 0:u.invoicePDFPreview.base64),S=ve(m);return{data:m||S,loading:v}}const Ca=k(Mt)`
  width: 100%;
  height: 100%;
  min-width: ${({$isEmpty:t})=>t?"540px":"auto"};
`,Ma={InvoicePdfPreview:Ca},Ta=()=>{const{setShowInvoicePreview:t}=q(),{control:a}=U(),o=te({control:a}),{data:n,loading:d}=xa({values:o});return e(Ma.InvoicePdfPreview,{data:n,fitBy:"height",isLoading:d,$isEmpty:!n,onClick:()=>t(!0)})},Da=k(_).attrs({headerStyle:{minHeight:40}})``,wa={FormSectionStyled:Da},Ue=({name:t,title:a,disabled:o,children:n})=>{const[d,l]=C.useState(!1),{control:i,setValue:r,watch:u}=U(),v=te({control:i,name:t});return C.useEffect(()=>{v&&l(!0)},[t,v,u]),e(h,{vertical:!0,fullWidth:!0,gap:16,"data-test":"InvoiceTextAreaFormField-Stack",children:e(wa.FormSectionStyled,{title:a,optional:!0,fullSize:!0,rightIcon:d?e(y,{neutral:!0,primary:!0,size:"small",onClick:()=>{r(t,"",{shouldDirty:!0}),l(!1)},leftIcon:e(P,{name:"close_m",size:24,color:"--text-button-brand-primary-default","data-test":"InvoiceTextAreaFormField-Icon"}),"data-test":"InvoiceTextAreaFormField-Button",children:"Remove"}):null,children:c(h,{vertical:!0,gap:16,fullWidth:!0,align:"stretch","data-test":"InvoiceTextAreaFormField-Stack",children:[n,e(h,{fullWidth:!0,vertical:!0,"data-test":"InvoiceTextAreaFormField-Stack",children:d?e(L,{control:i,name:t,render:({field:{value:m,onChange:S}})=>e(pt,{label:"Your additional information",value:m??"",onChange:S,maxLength:200,disabled:o,"data-test":"InvoiceTextAreaFormField-TextArea"}),"data-test":"InvoiceTextAreaFormField-Controller"}):e(y,{neutral:!0,primary:!0,size:"small",onClick:()=>l(!0),disabled:o,leftIcon:e(P,{name:"edit_m",size:24,color:"--text-button-brand-primary-default","data-test":"InvoiceTextAreaFormField-Icon"}),"data-test":"InvoiceTextAreaFormField-Button",children:c(D,{font:"button-m",colorToken:"--text-button-brand-primary-default","data-test":"InvoiceTextAreaFormField-TSpan",children:["Edit ",a]})})})]})})})},ka=k(h).attrs({vertical:!0})`
  width: 100%;
  padding: 48px 24px 0;
  gap: 24px;

  @media ${We.TABLET} {
    gap: 40px;
  }
`,Ea=k.div`
  width: 100%;
  height: 1px;
  background-color: var(--bg-separator-neutral-default);
`,Pa=k(h)`
  width: 50%;
  height: 100%;
  background: var(--bg-body-neutral-alt-default);

  @media (max-width: ${ee.TABLET_MAX}) {
    width: 100%;
  }
`,za=k(h)`
  width: 50%;
  background-color: var(--bg-card-neutral-default);
  padding: 40px;
  justify-content: center;
`,Na=k(h)`
  max-width: 100%;

  @media ${We.TABLET} {
    top: 115px;
    position: fixed;
    height: calc(100vh - 165px); // 100vh minus header and paddings
  }
`,La=k(h).attrs({vertical:!0})`
  gap: 40px;
  max-width: 580px;
  margin: 0 auto;
  padding: 40px 24px;

  @media (max-width: ${ee.TABLET_MAX}) {
    max-width: 100%;
    width: 100%;
  }
`,Ba=k(h)`
  width: 100%;
  align-items: stretch;
`,B={PageCard:ka,Separator:Ea,PreviewContainer:za,LeftContainer:Pa,PreviewStickyContainer:Na,Container:Ba,FormContent:La},Aa=({predefinedNoumId:t,invoice:a})=>{const{control:o,watch:n,getValues:d,setValue:l}=U(),{isTablet:i,isDesktop:r}=V(),u=C.useRef(new Date),[v,m,S,f]=n(["noumId","status","serviceProviderId","dueDate"]),{setSelectedBuyer:x,setSelectedServiceProvider:F}=q(),g=Je();return c(B.Container,{children:[e(B.LeftContainer,{children:c(B.FormContent,{children:[c(h,{vertical:!0,gap:16,fullWidth:!0,"data-test":"InvoiceForm-Stack",children:[e(_,{fullSize:!0,title:"Noum Assignment",sectionSeparator:!1,"data-test":"InvoiceForm-FormSection",children:e(L,{control:o,name:"noumId",render:({field:{ref:b,...p},fieldState:s})=>e(Tt,{label:p.value?"":"Find a Noum...",inputSize:"small",preselectedItem:a==null?void 0:a.noumId,...p,disabled:!!t||!T.canEditField(m,"noumId"),onChange:M=>{p.onChange(M),d("buyerId")&&l("buyerId","",{shouldValidate:!0,shouldDirty:!0,shouldTouch:!0})},...K(s),"data-test":"InvoiceForm-ProjectNoumSelector"}),"data-test":"InvoiceForm-Controller"})}),c(h,{gap:i?16:24,align:"start",vertical:i,fullWidth:!0,"data-test":"InvoiceForm-Stack",children:[e(ba,{disabled:!v||!T.canEditField(m,"invoiceNumber"),"data-test":"InvoiceForm-InvoiceNumberField"}),e(h,{fullWidth:!r,"data-test":"InvoiceForm-Stack",children:e(L,{control:o,name:"issueDate",render:({field:{value:b,onChange:p},fieldState:{error:s}})=>e(Pe,{required:!0,fullSize:!0,placement:"bottom-end",dateFormat:"MMM dd, yyyy",size:"small",showIcon:!0,minDate:Ne(u.current,1),value:b?new Date(b):void 0,onChange:p,label:"Invoice Issue Date",error:!!(s!=null&&s.message),disabled:{before:u.current},"data-test":"InvoiceForm-DatePicker"}),"data-test":"InvoiceForm-Controller"})})]})]}),e(B.Separator,{}),e(_,{title:"Recipient",fullSize:!0,"data-test":"InvoiceForm-FormSection",children:e(L,{control:o,name:"buyerId",render:({field:{value:b,onChange:p},fieldState:s})=>e(N,{children:e(Le,{noumId:v,inputSize:"small",excludedIds:[S],label:"Find or Add a Buyer...",value:b,excludeCurrentUser:!0,preselectedContact:ue(a==null?void 0:a.invoiceTo),disabled:!T.canEditField(m,"buyerId"),onChange:(M,w)=>{x(w),p(M)},usePortal:!0,renderContainerFromBottom:!0,onContactInfoValidation:M=>{l("buyerDetailsComplete",M,{shouldDirty:!0,shouldValidate:!0})},...K(s),"data-test":"InvoiceForm-ContactSelector"})}),"data-test":"InvoiceForm-Controller"})}),e(B.Separator,{}),e(_,{title:"Service Provider",fullSize:!0,"data-test":"InvoiceForm-FormSection",children:e(L,{control:o,name:"serviceProviderId",render:({field:{onChange:b,value:p},fieldState:s})=>e(Le,{noumId:v,inputSize:"small",addContactDisabled:!0,label:"Find or add a Service Provider...",preselectedContact:ue(a==null?void 0:a.invoiceFrom)??ue(g),value:p,disabled:!T.canEditField(m,"serviceProviderId"),onChange:(M,w)=>{F(w),b(M)},clearButtonDisabled:!0,usePortal:!0,renderContainerFromBottom:!0,onContactInfoValidation:M=>{l("serviceProviderDetailsComplete",M,{shouldDirty:!0,shouldValidate:!0})},...K(s),"data-test":"InvoiceForm-ContactSelector"}),"data-test":"InvoiceForm-Controller"})}),e(B.Separator,{}),e(_,{fullSize:!0,sectionSeparator:!1,"data-test":"InvoiceForm-FormSection",children:e(Ue,{disabled:!T.canEditField(m,"summary"),name:"summary",title:"Attention","data-test":"InvoiceForm-InvoiceTextAreaFormField"})}),e(B.Separator,{}),e(_,{title:"Items",fullSize:!0,"data-test":"InvoiceForm-FormSection",children:e(ca,{"data-test":"InvoiceForm-InvoiceItemsWizard"})}),e(B.Separator,{}),c(h,{fullWidth:!0,vertical:!0,gap:16,"data-test":"InvoiceForm-Stack",children:[c(_,{fullSize:!0,title:"Payment",sectionSeparator:!1,"data-test":"InvoiceForm-FormSection",children:[e(D,{font:"body-m-bold","data-test":"InvoiceForm-TSpan",children:"Currency"}),e(L,{control:o,name:"currency",render:({field:{value:b,onChange:p}})=>{var s;return e(Ft,{inputSize:"small",hideIcons:!0,hideLeftIconPlace:!0,maxContainerHeight:"250px",disabled:!T.canEditField(m,"currency"),onChange:M=>p(M==null?void 0:M.value),inputValue:(s=T.getCurrencyByCode(b))==null?void 0:s.label,value:b,leftIcon:e(N,{}),usePortal:!0,renderContainerFromBottom:!0,rightIcon:e(N,{}),options:T.currencyOptions,"data-test":"InvoiceForm-ApiEntityPickerFieldWithLocalSearch"})},"data-test":"InvoiceForm-Controller"})]}),e(_,{fullSize:!0,title:"Due Date",font:"body-m-bold",sectionSeparator:!1,"data-test":"InvoiceForm-FormSection",children:c(h,{gap:8,vertical:i,"data-test":"InvoiceForm-Stack",children:[e(L,{control:o,name:"dueDate",render:({field:{value:b,onChange:p}})=>e(ne,{inputSize:"small",onChange:s=>{s.value===Be.CUSTOM_DATE?l("customDueDate",new Date,{shouldDirty:!0,shouldValidate:!0}):l("customDueDate",void 0),p(s.value)},value:b,disabled:!T.canEditField(m,"dueDate"),options:T.dueDateOptions,usePortal:!0,renderContainerFromBottom:!0,"data-test":"InvoiceForm-SelectField"}),"data-test":"InvoiceForm-Controller"}),f===Be.CUSTOM_DATE&&e(L,{control:o,name:"customDueDate",render:({field:{value:b,onChange:p},fieldState:{error:s}})=>e(Pe,{required:!0,fullSize:!0,placement:"bottom-end",dateFormat:"MMM dd, yyyy",size:"small",showIcon:!0,value:b?new Date(b):void 0,onChange:p,label:"Due date",error:!!(s!=null&&s.message),minDate:Ne(u.current,1),disabled:{before:u.current},"data-test":"InvoiceForm-DatePicker"}),"data-test":"InvoiceForm-Controller"})]})}),e(_,{title:"Payment Terms",font:"body-m-bold",sectionSeparator:!1,fullSize:!0,"data-test":"InvoiceForm-FormSection",children:e(L,{control:o,name:"paymentTerms",render:({field:{value:b,onChange:p}})=>e(ne,{inputSize:"small",onChange:s=>p(s.value),value:b,disabled:!T.canEditField(m,"paymentTerms"),options:T.paymentTermsOptions,usePortal:!0,renderContainerFromBottom:!0,"data-test":"InvoiceForm-SelectField"}),"data-test":"InvoiceForm-Controller"})}),e(_,{fullSize:!0,font:"body-m-bold",title:"Late Fee",sectionSeparator:!1,"data-test":"InvoiceForm-FormSection",children:e(sa,{disabled:!T.canEditField(m,"lateFeeType"),"data-test":"InvoiceForm-InvoiceLateFeeField"})})]}),e(B.Separator,{}),e(_,{title:"Upload your own logo",optional:!0,fullSize:!0,"data-test":"InvoiceForm-FormSection",children:e(pa,{"data-test":"InvoiceForm-InvoiceLogoUpload"})}),e(B.Separator,{}),e(Ue,{disabled:!T.canEditField(m,"notes"),name:"notes",title:"Notes","data-test":"InvoiceForm-InvoiceTextAreaFormField",children:e(xt,{type:"tertiary","data-test":"InvoiceForm-Infobox",children:"You may provide important information such as: bank account details, VAT number, or other relevant information"})}),e(B.Separator,{})]})}),r&&e(B.PreviewContainer,{children:e(B.PreviewStickyContainer,{children:e(Ta,{"data-test":"InvoiceForm-InvoicePreview"})})})]})};function de(t){const[a,o]=C.useState(!1);return[C.useCallback(async(...d)=>{o(!0);try{return await(t==null?void 0:t(...d))}finally{o(!1)}},[t]),a]}const _a=({onSave:t,onDelete:a,isValid:o,draftId:n,onSend:d,invoice:l,onDuplicate:i,...r})=>{const{isMobile:u}=V(),{control:v}=U(),m=te({control:v}),[S,f]=C.useState(),x=se(),{logError:F}=ce(),{openModal:g,closeModal:b,modalType:p}=le(),[s,M]=de(t),[w,I]=de(d),O=De();C.useEffect(()=>{f(new Date().toISOString())},[m]);const z=async()=>{try{await a(),x({pathname:Q.INVOICE_MANAGER})}catch{F(new Error("Unable to delete an invoice draft. Please try again later."),"onDeleteDraft")}},Y=e(y,{size:"small",intent:"negative",secondary:!0,disabled:!n,leftIcon:e(P,{name:"delete_m",size:16,"data-test":"InvoiceFormDraftHeader-DeleteDraftButton-Icon"}),onClick:()=>g("deleteDraft"),"data-test":"InvoiceFormDraftHeader-DeleteDraftButton-Button",children:"Delete draft"}),X=e(y,{size:"small",tertiary:!0,disabled:!n||!O.canDuplicate(l),leftIcon:e(P,{name:"copy_m",size:16,"data-test":"InvoiceFormDraftHeader-DuplicateInvoiceButton-Icon"}),onClick:i,"data-test":"InvoiceFormDraftHeader-DuplicateInvoiceButton-Button",children:"Duplicate"}),H=e(y,{size:"small",secondary:!0,loading:M,disabled:!r.hasUnsavedChanges&&!!n,onClick:s,"data-test":"InvoiceFormDraftHeader-SaveDraftButton-Button",children:"Save draft"}),$=e(y,{size:"small",intent:"positive",softDisabled:!o,disabled:!n,loading:I,onClick:w,"data-test":"InvoiceFormDraftHeader-ReviewAndSendButton-Button",children:"Review & Send"}),ae=u?c(N,{children:[$,e(fe,{containerWidth:"125px",neutral:!0,onClick:()=>{},menuOptions:[{key:"save-draft",label:"Save draft",type:"value",value:"save-draft",disabled:!r.hasUnsavedChanges,onClick:t},{key:"delete-draft",label:"Delete draft",type:"value",value:"delete-draft",intent:"danger",disabled:!n,onClick:()=>g("deleteDraft")}],iconColorToken:"--button-card-neutral-default","data-test":"InvoiceFormDraftHeader-DraftButtons-EllipsisMenu"})]}):c(N,{children:[X,Y,H,$]});return c(N,{children:[e(Ze,{...r,updatedAt:S,buttons:ae,"data-test":"InvoiceFormDraftHeader-StickyFormHeader"}),e(bt,{isOpenModal:p==="deleteDraft",onConfirm:z,onClose:()=>b(),"data-test":"InvoiceFormDraftHeader-DeleteDraftModal"})]})},Ra=({isOpenModal:t,amount:a,currency:o,customerName:n,loading:d,onClose:l,onConfirm:i})=>e(G,{isFullScreen:!1,open:t,testId:"update_invoice_modal",onClose:l,disableBackdropClick:!0,"data-test":"UpdateInvoiceModal-Modal",children:c(h,{gap:16,padding:14,vertical:!0,maxWidth:327,align:"center",justify:"center","data-test":"UpdateInvoiceModal-Stack",children:[e(D,{font:"heading-s-bold",colorToken:"--text-modal-header-neutral-default","data-test":"UpdateInvoiceModal-TSpan",children:"Update Invoice"}),c(D,{"data-testid":"confirm_text",font:"body-l",textAlign:"center",colorToken:"--text-modal-neutral-default","data-test":"UpdateInvoiceModal-TSpan",children:["Do you want to update the invoice for"," ",W(a,o)," to ",n,"?"]}),c(h,{vertical:!0,gap:16,fullWidth:!0,padding:"12px 0 0","data-test":"UpdateInvoiceModal-Stack",children:[e(y,{primary:!0,size:"full",testId:"confirm_btn",grow:!0,onClick:i,loading:d,"data-test":"UpdateInvoiceModal-Button",children:"Update Invoice"}),e(y,{tertiary:!0,onClick:l,size:"full",testId:"cancel_btn","data-test":"UpdateInvoiceModal-Button",children:"Continue Editing"})]})]})}),Ua=({onSave:t,isValid:a,onSend:o,onDuplicate:n,invoice:d,values:l,isDraft:i,hasUnsavedChanges:r,...u})=>{const{control:v}=U(),m=te({control:v}),[S,f]=C.useState(),[x,F]=de(t),[g,b]=de(o),{openModal:p,closeModal:s,modalType:M}=le(),{selectedBuyer:w}=q(),I=De();C.useEffect(()=>{f(new Date().toISOString())},[m]);const O=async()=>{i?x():p("updateInvoice")},z=d&&I.canDuplicate(d)?e(y,{size:"small",tertiary:!0,leftIcon:e(P,{name:"copy_m",size:16,"data-test":"InvoiceFormEditHeader-DuplicateInvoiceButton-Icon"}),onClick:n,"data-test":"InvoiceFormEditHeader-DuplicateInvoiceButton-Button",children:"Duplicate"}):null,X=c(N,{children:[z,e(y,{size:"small",softDisabled:!a,disabled:!r,onClick:O,loading:F,primary:!0,"data-test":"InvoiceFormEditHeader-SaveAndResendButton-Button",children:"Save & Resend"})]}),H=c(N,{children:[z,e(y,{size:"small",disabled:!r,onClick:O,loading:F,primary:!0,"data-test":"InvoiceFormEditHeader-DraftButtons-Button",children:"Save Changes"}),e(y,{size:"small",softDisabled:!a,onClick:g,loading:b,intent:"positive",primary:!0,"data-test":"InvoiceFormEditHeader-DraftButtons-Button",children:"Review & Send"})]}),$=T.getAllItemsTotalValue(l.lineItems);return c(N,{children:[e(Ze,{...u,updatedAt:S,buttons:i?H:X,"data-test":"InvoiceFormEditHeader-StickyFormHeader"}),e(Ra,{isOpenModal:M==="updateInvoice",onConfirm:async()=>{await x(),s()},loading:F,onClose:s,amount:$,currency:l.currency,customerName:(w==null?void 0:w.name)??"","data-test":"InvoiceFormEditHeader-UpdateInvoiceModal"})]})},Oa=({values:t})=>{const{shouldShowInvoicePreview:a,setShowInvoicePreview:o,selectedServiceProvider:n,selectedBuyer:d}=q(),{data:l}=ht({variables:{data:t&&a?re.toInvoicePDFPreview(t,d,n):void 0},skip:!a||!t}),{download:i}=Bt(),r=()=>{t!=null&&t.id&&t.invoiceNumber&&i(t.id,t.invoiceNumber)},u=re.toBase64Data(l==null?void 0:l.invoicePDFPreview.base64);return u&&a?e(vt,{isOpen:a,handleClose:()=>o(!1),handleDownload:t!=null&&t.id?r:void 0,setDocError:()=>{},url:u||"","data-test":"InvoicePreviewModal-DocViewer"}):null};function Wa({id:t,noumId:a}){const o=se(),[n,d]=C.useState(!!t),{setSelectedBuyer:l,setSelectedServiceProvider:i}=q(),r=Je(),{addErrorToast:u,addSuccessIconToast:v}=xe(),[m]=Me(),S=!!m.get("duplicate"),f=wt({defaultValues:ie.getDefaultValues({id:t,noumId:a})}),x=f.watch("serviceProviderId");C.useEffect(()=>{r&&!x&&(f.setValue("serviceProviderId",r._id),i(me(r)))},[r,f,x,i]);const F=C.useCallback(I=>{I.id&&o({pathname:Te(Q.INVOICE_EDIT,{id:I.id}),search:"?draft=true"},{replace:!0})},[o]),{saveDraft:g,deleteInvoice:b,duplicateInvoice:p,invoiceId:s,invoice:M}=At({invoiceId:t,onCreated:F,onLoad:I=>{T.isInvoiceEditable(I==null?void 0:I.status)||o(Q.INVOICE_MANAGER),I&&(f.reset(ie.fromInvoice(I)),i(I.invoiceFrom?me(I.invoiceFrom):null),l(I.invoiceTo?me(I.invoiceTo):null),S&&I.duplicatedFromInvoiceId&&v("Your invoice has been duplicated."),d(!1))}}),w=C.useCallback(async()=>{try{const I=await p();I!=null&&I.id&&window.open(T.createInvoicePath.duplicateInvoice(I.id),"_blank")}catch{u("Failed to duplicate invoice")}},[u,p]);return{form:f,isLoading:n,invoiceId:s,invoice:M,duplicateInvoice:p,saveDraft:g,deleteInvoice:b,handleDuplicate:w}}const Va=({status:t})=>{const a=se(),{id:o}=Ge(),[n]=Me();C.useEffect(()=>{o&&t&&t!==Ve.Draft&&n.get("draft")&&a(Te(Q.INVOICE_EDIT,{id:o}),{replace:!0})},[o,a,n,t])},$a=()=>{const t=se(),{id:a}=Ge(),{logError:o}=ce(),[n]=Me(),d=n.get("noumId")??a??void 0,l=!!a&&!n.get("draft"),{addSuccessIconToast:i,addPrimaryIconToast:r,addToast:u}=xe(),{closeModal:v,openModal:m,modalType:S,contextData:f}=le(),{selectedBuyer:x}=q(),{isNoumOwner:F}=De(),{form:g,isLoading:b,saveDraft:p,deleteInvoice:s,handleDuplicate:M,invoiceId:w,invoice:I}=Wa({id:a,noumId:d}),O=g.watch("noumId"),z=te({control:g.control}),[Y]=_t();Va({status:I==null?void 0:I.status});const{goBackToOrigin:X}=Rt(),H=C.useCallback(async()=>{const Z=g.getValues();if(!O){r("Please assign the Noum first in order to save your draft.");return}try{await p(Z),g.reset(void 0,{keepValues:!0,keepIsValid:!0,keepErrors:!0,keepDirty:!1,keepDirtyValues:!1}),i(l?"Your invoice has been updated.":"Your draft has been saved.")}catch{const oe=new Error("Unable to create a draft invoice. Please try again later.");o(oe,"InvoiceCreateScreen")}},[r,i,l,g,o,O,p]),{handleSubmit:$}=g,ae=C.useCallback(async Z=>{try{await p(Z);const{isConnected:oe,isSecretNoum:et}=await Y(Z.noumId,Z.buyerId);if(et&&!oe){m("secretNoumAlert",ft.isUnauthenticated(x));return}w&&t(Te(Q.INVOICE_PREVIEW,{id:w}))}catch{o(new Error("Unable to update an invoice draft. Please try again later."),"updateDraft")}},[p,Y,w,m,x,t,o]),we=()=>{X({fallbackUrl:Q.INVOICE_MANAGER})},ke=()=>{u("error","icon","Please check all the required fields to continue.")},Ee=I!=null&&I.duplicatedFromInvoiceNumber&&F(I)?`Duplicated from ${I.duplicatedFromInvoiceNumber}`:null;return e(Ut,{"data-test":"InvoiceCreateScreen-FullScreenLayout",children:e(Ae.Container,{children:e(St,{isLoading:!1,"data-test":"InvoiceCreateScreen-SkeletonLoaderProvider",children:c(yt,{...g,"data-test":"InvoiceCreateScreen-FormProvider",children:[!I&&b?e(Ce,{"data-test":"InvoiceCreateScreen-Spinner"}):c(N,{children:[e(Ae.FormHeaderContainer,{children:l?e(Ua,{title:"Edit invoice",onSave:H,onSend:$(ae,ke),hasUnsavedChanges:g.formState.isDirty,isValid:g.formState.isValid,invoice:I,values:z,isDraft:(I==null?void 0:I.status)===Ve.Draft,onGoBack:we,onDuplicate:()=>m("duplicate-invoice"),badgeText:Ee,isFullScreenMode:!0,"data-test":"InvoiceCreateScreen-InvoiceFormEditHeader"}):e(_a,{title:"New invoice",draftId:w,onDelete:s,onSave:H,invoice:I,onSend:$(ae,ke),hasUnsavedChanges:g.formState.isDirty,isValid:g.formState.isValid,onGoBack:we,onDuplicate:()=>m("duplicate-invoice"),badgeText:Ee,isFullScreenMode:!0,"data-test":"InvoiceCreateScreen-InvoiceFormDraftHeader"})}),e(Aa,{predefinedNoumId:d,invoice:I,"data-test":`InvoiceCreateScreen-InvoiceForm-${d}`},d)]}),e(Oa,{values:z,"data-test":"InvoiceCreateScreen-InvoicePreviewModal"}),e(Et,{isOpenModal:S==="secretNoumAlert",onClose:v,isUnauthenticated:!!f,"data-test":"InvoiceCreateScreen-InvoiceSecretNoumAlertModal"}),e(gt,{isOpenModal:S==="duplicate-invoice",onClose:v,onConfirm:()=>{M(),v()},"data-test":"InvoiceCreateScreen-DuplicateInvoiceModal"})]})})})})},Po=()=>e(kt,{"data-test":"InvoiceProvider",children:e($a,{"data-test":"InvoiceCreateScreen"})});export{Po as default};
//# sourceMappingURL=InvoiceCreate-876b1150.js.map
