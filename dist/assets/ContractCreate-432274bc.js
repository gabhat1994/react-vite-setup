import{j as e,y as J,m as ce,ae as ue,a2 as Ce,c as S,x as v,da as P,F as W,T as X,b3 as be,v as ye,Y as me,aR as we,ev as ve,R as fe,I as pe,qF as _e,eL as De,qG as Ie,aC as H,qH as Fe,qI as Te,c_ as Pe,X as Le,eu as re,n as We,Q as Oe,B as xe,eq as Ee}from"./index-cd84bcc9.js";import{ac as ze,am as R,an as D,bI as ne,bH as Ae,bG as Ne,ap as Me,aq as Re,bE as K,C as z,r as b,bb as F,ar as $,b2 as qe,l as Y,bz as he,be as $e,a6 as Be,aa as Ue,bc as Ve,bo as He,aT as j}from"./vendor-51460554.js";import{F as T,u as je,a as Ge,I as Se,D as Qe}from"./index-be450a41.js";import{m as ie,C as se}from"./contactMapper-463fcf05.js";import{A as Z}from"./useUpdateNoumContact-9e0e7edc.js";import{a as le,g as L}from"./forms-18e3c53a.js";import{T as Xe}from"./index-1f4ed9fc.js";import{D as ee,S as Ye}from"./statementOfWork-e03c986f.js";import{b as te,T as Je,a as Ke,u as Ze}from"./PdfPreviewThumbnail-3547d9fe.js";import"./ApiEntityPickerField-cfd6d0d6.js";import{F as et}from"./Flag-d41fef47.js";import{g as tt,h as ge,a as at,b as ot,c as rt,d as nt,C as G,u as it}from"./contract-546e6b09.js";import{S as st}from"./StickyFormHeader-043ef98d.js";import{u as ke}from"./navigation-419d637e.js";import{D as lt}from"./DeleteDocumentConfirmationModal-44709272.js";import{a as dt,b as ct,c as ut,S as Q}from"./Section-2a57cf43.js";import{C as q}from"./contract-47e31a61.js";import{u as mt}from"./contractPermissions-cf3fd14b.js";import{S as ft,R as pt}from"./index-38931f83.js";import{b as ht}from"./contractPdf-f9d6c58f.js";import"./contactDetails-4902172b.js";import"./countries-4aa86a38.js";import"./SelectField-54706174.js";import"./styles-46bbc451.js";import"./Modal-5a254f40.js";import"./index-4963229a.js";import"./useResizeObserver-0deb9469.js";import"./utils-87d126b1.js";import"./payloadParser-f4cc4e4f.js";import"./styles-5db1c009.js";import"./ChamberLeftSideBar-2a7f8e7f.js";import"./index-2d186805.js";import"./sideNavItems-22800105.js";import"./styles-b4894a1f.js";const St=ze.forwardRef(({step:t=1,min:o,max:n,...a},r)=>e(J,{ref:r,type:"number",step:t,min:o,max:n,...a,"data-test":"IncrementalNumberField-TextField"})),ae=R({title:D().required("The title of the Contract cannot be empty.").trim().ensure().label("Title"),noumId:D().required().ensure().label("Noum Assignment"),buyerId:D().required().label("Buyer"),serviceProviderId:D().required().label("Service Provider"),buyerDetailsComplete:ne().is([!0]),serviceProviderDetailsComplete:ne().is([!0]),effectiveDate:Ae().required().label("Effective Date"),terminationNotice:D().ensure().optional().label("Termination Notice").typeError(({label:t,type:o})=>`${t} must be a ${o}.`),governingLaw:R({country:D().required().label("Country"),region:D().required().label("Region")}).required().label("Governing Law"),arbitration:R({country:D().required().label("Country"),region:D().required().label("Region")}).required().label("Arbitration"),linkedStatementsOfWork:Ne(R({statementOfWorkId:D().required().ensure()}).required()).required()});function gt({defaultValues:t}={}){return Me({defaultValues:t,resolver:Re(ae),mode:"onSubmit"})}function oe(){return K()}const kt=z(ue)`
  padding: 24px;
  // Don't clip dropdown popover layer
  overflow: visible;

  @media (max-width: ${ce.TABLET_MAX}) {
    border-radius: 0;
  }
`,Ct=z(Ce)`
  width: 100%;
`,x={Card:kt,Separator:Ct},bt=tt().map(t=>({type:"value",key:t.code,label:t.label,value:t.code,icon:e(et,{flag:`flag_${t.code}`,size:24,"data-test":"countryOptions-Flag"})}));function yt({onChange:t,...o}){return e(Z,{...o,hideIcons:!1,inputSize:"small",onChange:n=>t(n==null?void 0:n.key),options:bt,renderSelectionPreviewComponent:n=>e(te,{...n,onChange:()=>t(""),bold:!1,"data-test":"ApiEntitySelectionPreviewComponent"}),"data-test":"ApiEntityPickerFieldWithLocalSearch"})}function wt({onChange:t,country:o,...n}){const a=b.useMemo(()=>!o||!ge(o)?[]:at(o).map(r=>({type:"value",key:r.code,label:r.label,value:r.code})),[o]);return e(Z,{...n,inputSize:"small",onChange:r=>t(r==null?void 0:r.key),options:a,renderSelectionPreviewComponent:r=>e(te,{...r,bold:!1,onChange:()=>t(""),"data-test":"ApiEntitySelectionPreviewComponent"}),"data-test":"ApiEntityPickerFieldWithLocalSearch"})}function de({name:t}){const{control:o,watch:n,setValue:a}=oe(),r=n(`${t}.country`);return S(v,{gap:16,fullWidth:!0,"data-test":"Stack",children:[e(P,{grow:1,basis:"50%","data-test":"StackItem",children:e(F,{name:`${t}.country`,control:o,render:({field:{onChange:i,value:c},fieldState:u})=>e(yt,{disabled:!0,placeholderText:"Country",maxContainerHeight:"300px",value:c,onChange:g=>{i(g),a(`${t}.region`,"")},...le(u),"data-test":"ContractCountrySelector"}),"data-test":"Controller"})}),r&&!ot(r)&&e(P,{grow:1,basis:"50%","data-test":"StackItem",children:e(F,{name:`${t}.region`,control:o,render:({field:{onChange:i,value:c},fieldState:u})=>ge(r)?e(wt,{placeholderText:rt(r)?"State":"Region",maxContainerHeight:"300px",hideIcons:!0,hideLeftIconPlace:!1,country:r,value:c,onChange:i,...le(u),"data-test":"ContractCountryRegionSelector"}):nt(r)?e(J,{value:c,onChange:i,placeholder:"Region",inputSize:"small","data-test":"TextField"}):e(W,{}),"data-test":"Controller"})})]})}function vt({documentStatus:t,isPreDraft:o,disableNoum:n=!1,contract:a,onContactDetailsUpdated:r}){const{t:i}=$(),{control:c,setValue:u,watch:g}=oe(),[f,h,y]=g(["noumId","buyerId","serviceProviderId"]),l=b.useMemo(()=>ie(a==null?void 0:a.buyer),[a==null?void 0:a.buyer]),s=b.useMemo(()=>ie(a==null?void 0:a.seller),[a==null?void 0:a.seller]);return S(W,{children:[e(x.Card,{children:S(v,{gap:16,justify:"stretch",align:"center","data-test":"Stack",children:[e(X,{font:"heading-xs-bold","data-test":"TSpan",children:i("noumena.contract_form.fields.title")}),e(P,{grow:!0,"data-test":"StackItem",children:e(F,{name:"title",control:c,render:({field:p,fieldState:m})=>e(J,{inputSize:"small",rightIcon:e(Xe,{top:30,left:20,"data-test":"Tooltip",children:e(Je,{"data-test":"TooltipMessage",children:i("noumena.contract_form.title.tooltip")})}),...p,...L(m),"data-test":"TextField"}),"data-test":"Controller"})}),e(ee,{status:t,size:"medium","data-test":"DocumentStatusTag"})]})}),e(x.Card,{children:S(v,{vertical:!0,gap:16,"data-test":"Stack",children:[e(T,{label:i("noumena.contract_form.fields.noum_assignment"),description:n?void 0:i("noumena.contract_form.fields.noum_assignment.description"),"data-test":"FormControl",children:e(F,{name:"noumId",render:({field:{ref:p,...m},fieldState:d})=>e(Ke,{...m,...L(d),disabled:n,label:"",preselectedItem:a==null?void 0:a.linkedNoum,inputSize:"small",placeholderText:i("noumena.contract_form.fields.noum_assignment.placeholder"),"data-test":"ProjectNoumSelector"}),"data-test":"Controller"})}),e(T,{label:i("noumena.contract_form.fields.buyer"),"data-test":"FormControl",children:e(F,{name:"buyerId",render:({field:{ref:p,...m},fieldState:d})=>e(se,{...m,...L(d),noumId:f,inputSize:"small",fullWidth:!0,label:"",excludedIds:[y],placeholderText:i("noumena.contract_form.fields.buyer.placeholder"),onContactInfoValidation:k=>{u("buyerDetailsComplete",k,{shouldValidate:!0,shouldDirty:!0})},disabled:o,preselectedContact:l,onContactDetailsUpdate:r,"data-test":"ContactSelector"}),"data-test":"Controller"})}),e(x.Separator,{}),e(T,{label:i("noumena.contract_form.fields.service_provider"),"data-test":"FormControl",children:e(F,{name:"serviceProviderId",render:({field:{ref:p,...m},fieldState:d})=>e(se,{...m,...L(d),noumId:f,inputSize:"small",label:"",fullWidth:!0,excludedIds:[h],placeholderText:i("noumena.contract_form.fields.buyer.placeholder"),disabled:o,preselectedContact:s,onContactInfoValidation:k=>{u("serviceProviderDetailsComplete",k,{shouldValidate:!0,shouldDirty:!0})},onContactDetailsUpdate:r,"data-test":"ContactSelector"}),"data-test":"Controller"})}),e(x.Separator,{}),S(v,{gap:16,justify:"stretch",fullWidth:!0,"data-test":"Stack",children:[e(T,{label:i("noumena.contract_form.fields.effective_date"),"data-test":"FormControl",children:e(F,{name:"effectiveDate",control:c,render:({field:{ref:p,...m},fieldState:d})=>e(be,{...m,fullSize:!0,size:"small",disabled:o,...L(d),required:!0,"data-test":"DatePicker"}),"data-test":"Controller"})}),e(T,{label:i("noumena.contract_form.fields.termination_notice"),optional:!0,"data-test":"FormControl",children:S(v,{gap:12,align:"center","data-test":"Stack",children:[e(F,{name:"terminationNotice",control:c,render:({field:p,fieldState:m})=>e(St,{step:1,min:0,max:90,inputSize:"small",disabled:o,...p,...L(m),"data-test":"IncrementalNumberField"}),"data-test":"Controller"}),e(X,{font:"body-l",colorToken:"--text-card-neutral-default","data-test":"TSpan",children:i("noumena.contract_form.fields.termination_notice.unit")})]})})]}),e(x.Separator,{}),S(v,{gap:16,justify:"stretch",fullWidth:!0,"data-test":"Stack",children:[e(T,{label:i("noumena.contract_form.fields.governing_law"),"data-test":"FormControl",children:e(de,{name:"governingLaw","data-test":"ContractLegalRegionSelector"})}),e(T,{label:i("noumena.contract_form.fields.arbitration"),"data-test":"FormControl",children:e(de,{name:"arbitration","data-test":"ContractLegalRegionSelector"})})]})]})})]})}const _t=({contract:t,isEditMode:o,onSaveDraft:n,onSaveDraftSuccess:a,onDeleteDraft:r,onGoBackToList:i})=>{const{navigateAndPassOrigin:c}=ke(),{t:u}=$(),{addPrimaryIconToast:g,addSuccessIconToast:f,addErrorToast:h}=ye(),{logError:y}=me(),{modalType:l,openModal:s,closeModal:p}=we(),m=mt(),d=K(),{watch:k,formState:{isDirty:w}}=d,{lastSavedAt:C,markLocalChangesAsSaved:A}=je({form:d}),B=k("title"),N=async()=>{if(t!=null&&t._id){if(!m.canSeeSummary(t)){await d.trigger(),h(u("noumena.contract_form.toast.not_completed"));return}w&&await O(),c(qe(fe.CONTRACT_PREVIEW,{id:t._id}))}},O=async()=>{const I=ae.cast(d.getValues());if(!I.noumId){g(u("noumena.contract_form.toast.no_noum_selected"));return}try{const _=await n(I);if(!_)return;a==null||a(_),A(),f(u("noumena.contract_form.toast.draft_saved"))}catch(_){y(_,"contract-save-draft")}},M=()=>{o?s("delete"):i()},U=async()=>{try{await r(),f(u("noumena.contract_form.toast.draft_deleted")),p(),i()}catch(I){p(),y(I,"contract-delete-draft")}};return S(W,{children:[e(st,{title:u(o?"noumena.contract_form.title.edit":"noumena.contract_form.title.create"),hasUnsavedChanges:w,updatedAt:C==null?void 0:C.toISOString(),buttons:S(W,{children:[e(dt,{onClick:M,isDraft:q.isDraft(t)}),e(ct,{isDraft:q.isDraft(t),onClick:O,disabled:!o||!w}),e(ut,{onClick:N,softDisabled:!o||!m.canSeeSummary(t)})]}),"data-test":"ContractFormHeader-StickyFormHeader"}),e(lt,{isOpen:l==="delete",isDraft:q.isDraft(t),documentName:B,documentType:ve.Contract,onCancel:p,onDelete:U,"data-test":"ContractFormHeader-DeleteDocumentConfirmationModal"})]})};function Dt({index:t,fieldNamePrefix:o,options:n}){const{t:a}=$(),{watch:r}=K(),{deleteItem:i}=Ge(),u=r("linkedStatementsOfWork").map(f=>f.statementOfWorkId),g=n.filter(f=>!u.includes(f.key));return e(Se.EditMode,{children:({control:f})=>e(P,{grow:!0,"data-test":"StackItem",children:e(F,{control:f,name:`${o}statementOfWorkId`,render:({field:{value:h,onChange:y}})=>e(Z,{autoFocus:!0,inputSize:"small",options:h?n:g,value:h,placeholderText:a("noumena.contract_form.linked_statements_of_work.id.placeholder"),onChange:l=>{y(l==null?void 0:l.key)},renderSelectionPreviewComponent:l=>{var m;const s=(m=l.selectedOption)==null?void 0:m.value,p=!(s!=null&&s.canEdit);return e(te,{...l,inputSize:"small",softDisabled:p,softDisabledReason:p?a("noumena.contract_form.linked_statements_of_work.tooltip.editing_disabled"):void 0,onChange:()=>{i(t)},selectedRightSideOption:s&&e(ee,{status:s.status,size:"small","data-test":"DocumentStatusTag"}),"data-test":"ApiEntitySelectionPreviewComponent"})},"data-test":"ApiEntityPickerFieldWithLocalSearch"}),"data-test":"Controller"})})})}const It={id:"",statementOfWorkId:""};function Ft({options:t,canAdd:o}){const n=Ze({name:"linkedStatementsOfWork",initialMode:"preview"});return e(Se.Wizard,{name:"linkedStatementsOfWork",canAdd:o,...n,newItemValues:It,EditModeComponent:a=>e(Dt,{...a,options:t,"data-test":"EditMode"})})}function Tt(t){return{type:"value",key:t._id,label:t.title,value:{...t,canEdit:Ye.isDraft(t)},icon:e(pe,{name:"file_m",size:24,"data-test":"Icon"}),rightIcon:e(ee,{status:t.status,size:"small","data-test":"DocumentStatusTag"})}}function Pt({linkedSows:t,unlinkedSows:o}){const n=oe(),a=b.useMemo(()=>Y.orderBy([...t,...o].map(Tt),"label","asc"),[t,o]),r=n.watch("linkedStatementsOfWork"),i=a.length-r.length>0,c=r.filter(u=>u.statementOfWorkId==="").length>0;return e(he,{...n,"data-test":"FormProvider",children:e(Ft,{options:a,canAdd:i&&!c,"data-test":"LinkedStatementsOfWorkWizard"})})}function Lt({contractId:t,noumId:o}){var y,l;const n=$e(),[a]=_e(),r=De({notifyOnNetworkStatusChange:!0,fetchPolicy:"cache-and-network",variables:{contractId:t},skip:!t}),i=Ie({notifyOnNetworkStatusChange:!0,fetchPolicy:"cache-and-network",variables:{noumId:o},skip:!t||!o}),c=b.useMemo(()=>{var s;return H((s=r.data)==null?void 0:s.getLinkedSOWs.data)},[(y=r.data)==null?void 0:y.getLinkedSOWs.data]),u=b.useMemo(()=>{var s;return H((s=i.data)==null?void 0:s.getAllSOW.data)},[(l=i.data)==null?void 0:l.getAllSOW.data]),g=b.useCallback(async s=>{t&&await a({variables:{contractId:t,sowId:s,link:!0}})},[a,t]),f=b.useCallback(async s=>{t&&await a({variables:{contractId:t,sowId:s,link:!1}})},[a,t]),h=async s=>{var w;const p=c.map(C=>C._id),m=H((w=s.linkedStatementsOfWork)==null?void 0:w.map(C=>C==null?void 0:C.statementOfWorkId)),d=Y.difference(m,p),k=Y.difference(p,m);await Promise.all([...d.map(g),...k.map(f)]),(d.length>0||k.length>0)&&n.refetchQueries({include:[Fe,Te]})};return{linkedSows:{data:c,loading:r.loading},unlinkedSows:{data:u,loading:i.loading},synchronizeLinkedSows:h}}function Wt({id:t,noumId:o,onCreate:n}){const{logError:a}=me(),[r,i]=b.useState(!1),[c,u]=b.useState(!1),g=gt({defaultValues:G.getDefaultValues({noumId:o})}),{reset:f,getValues:h,watch:y}=g,{isLoading:l,contract:s,createContract:p,updateContract:m,deleteContract:d}=it({id:t}),k=y("noumId")??o,w=!!t,{linkedSows:C,unlinkedSows:A,synchronizeLinkedSows:B}=Lt({contractId:t,noumId:k}),{loading:N,data:O}=C,{loading:M}=A,U=async I=>{try{const _=await m(I);return _&&(u(!0),await B(I)),_}catch{return null}finally{u(!1)}};return b.useEffect(()=>{s&&f({...h(),...G.fromContract(s)})},[s,h,f]),b.useEffect(()=>{!N&&!M&&!c&&f({...h(),...G.fromLinkedSows(O)},{keepDirty:!0})},[h,N,M,c,O,f]),b.useEffect(()=>{async function I(){const _=ae.cast(h());try{i(!0);const V=await p({..._,noumId:k});n(V._id)}catch(V){a(V,"contract-create-draft")}finally{i(!1)}}!w&&k&&I()},[h,w,k]),{form:g,isLoading:l,isCreating:r,isEditMode:w,contract:s,sowLinking:{linkedSows:C,unlinkedSows:A},saveDraft:U,deleteDraft:d}}const Ot=z(ue)`
  padding: 24px;
  overflow: visible;

  @media (max-width: ${ce.TABLET_MAX}) {
    border-radius: 0;
  }
`,xt=z.div`
  width: 390px;
  height: 550px;
  border: 1px solid var(--border-card-neutral-default);
`,Et=Be`
  color: var(--text-card-neutral-default);
  font: ${Pe.bodyMedium};
`,zt=z.div`
  ${Et}
`,E={Card:Ot,PdfPreview:xt,StatementOfWorkDescription:zt};function Sa(){const{id:t}=Ue(),[o]=Ve(),{t:n}=$(),{isDesktop:a}=Le(),{navigateAndPassOrigin:r,goBackToOrigin:i}=ke(),c=o.get("noumId")??void 0,u=b.useCallback(C=>{r(re.editContract({id:C,noumId:c}),{replace:!0})},[r,c]),{form:g,isLoading:f,isEditMode:h,isCreating:y,contract:l,sowLinking:s,deleteDraft:p,saveDraft:m}=Wt({id:t,noumId:c,onCreate:u}),d=ht({id:l==null?void 0:l._id}),k=()=>{i({fallbackUrl:re.contractManager()})};if(t&&!l&&!f)return e(He,{to:fe.NOT_FOUND,replace:!0,"data-test":"Navigate"});const w=q.formatPdfFileName({title:g.watch("title"),contractNumber:l==null?void 0:l.contractNumber});return e(ft,{"data-test":"SinglePageLayout",children:S(he,{...g,"data-test":"FormProvider",children:[e(_t,{contract:l,isEditMode:h,onSaveDraft:m,onSaveDraftSuccess:()=>d.refetch(),onDeleteDraft:p,onGoBackToList:k,"data-test":"ContractFormHeader"}),e(pt,{"data-test":"ResponsiveMain",children:f?e(We,{"data-test":"Spinner"}):S(v,{gap:24,"data-test":"Stack",children:[e(P,{grow:!0,"data-test":"StackItem",children:S(v,{gap:a?24:8,vertical:!0,align:"stretch","data-test":"Stack",children:[e(vt,{documentStatus:(l==null?void 0:l.status)??Oe.Draft,disableNoum:!!c,isPreDraft:y||!h,contract:l,onContactDetailsUpdated:()=>d.refetch(),"data-test":"ContractForm"}),!!l&&e(E.Card,{children:e(Q,{title:n("noumena.contract_form.fields.sow_attachment.title"),optional:!0,hasSeparator:!0,"data-test":"Section",children:e(v,{gap:16,vertical:!0,align:"stretch","data-test":"Stack",children:s.linkedSows.loading?S(W,{children:[e(j,{height:32,"data-test":"Skeleton"}),e(j,{height:32,"data-test":"Skeleton"}),e(j,{height:32,"data-test":"Skeleton"})]}):s.linkedSows.data.length>0||s.unlinkedSows.data.length>0?S(W,{children:[e(E.StatementOfWorkDescription,{children:n("noumena.contract_form.statement_of_work_attachment.description")}),e(Pt,{linkedSows:s.linkedSows.data,unlinkedSows:s.unlinkedSows.data,"data-test":"LinkedStatementsOfWorkForm"})]}):e(E.StatementOfWorkDescription,{children:n("noumena.contract_form.statement_of_work_attachment.none_available.description")})})})})]})}),e(P,{basis:"390px","data-test":"StackItem",children:S(v,{vertical:!0,gap:24,grow:!1,align:"stretch","data-test":"Stack",children:[a&&e(E.Card,{children:e(Q,{title:n("noumena.contract_form.contract_preview.title"),variant:"sub-section","data-test":"Section",children:S(v,{gap:16,vertical:!0,align:"stretch","data-test":"Stack",children:[e(Qe,{data:d.pdfData,downloadFileName:w,isLoading:d.loading,"data-test":"DocumentPdfThumbnail"}),e(xe,{tertiary:!0,icon:e(pe,{name:"download_m",size:24,"data-test":"Icon"}),disabled:!d.pdfData,onClick:()=>{d.pdfData&&Ee(d.pdfData,"application/pdf",w)},"data-test":"Button",children:n("noumena.contract_form.contract_preview.download")})]})})}),e(P,{grow:!1,shrink:!0,"data-test":"StackItem",children:e(E.Card,{children:e(Q,{title:n("noumena.contract_form.disclaimer.title"),variant:"sub-section","data-test":"Section",children:e(X,{font:"body-m",colorToken:"--text-card-neutral-default","data-test":"TSpan",children:n("noumena.contract_form.disclaimer.description")})})})})]})})]})})]})})}export{Sa as default};
//# sourceMappingURL=ContractCreate-432274bc.js.map
