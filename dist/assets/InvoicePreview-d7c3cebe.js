import{X as Y,Y as $,aR as z,c as u,F as S,j as e,B as l,I as p,R as y,b8 as q,aQ as G,b9 as x,x as L,ba as ne,M as oe,t as ie,h as re,i as se,T as U,v as X,b6 as V,f as ce,n as de,a1 as le,bb as ue,b7 as me}from"./index-cd84bcc9.js";import{U as ve}from"./UnauthenticatedHeader-60009936.js";import{a9 as N,b2 as T,be as J,l as Ie,r as W,aa as K,aB as Z,bo as pe}from"./vendor-51460554.js";import{D as fe,a as he}from"./DeleteDraftModal-e41d0b22.js";import{S as Q}from"./StickyFormHeader-043ef98d.js";import{E as ee}from"./EllipsisMenu-8495dca0.js";import{u as we,a as ye,b as Pe}from"./InvoiceSecretNoumAlertModal-f1c02a3f.js";import{I as Ce,u as Se}from"./useInvoice-3a46c6ed.js";import{a as A,u as te}from"./useInvoicePdfDownload-84ddf906.js";import{u as Me,C as De,M as ae}from"./MakeInvoicePaymentWizard-83291728.js";import{P as ge,I as Be,a as ke,b as be}from"./InvoiceTimeline-e66f8fb7.js";import{u as He}from"./contactNoumConnection-819cdc27.js";import{u as Ee}from"./navigation-419d637e.js";import{F as Ue}from"./index-af3e0302.js";import{R as Te}from"./index-38931f83.js";import{S as j}from"./styles-2c16e7fb.js";import{I as ze}from"./invoice-e39dbdbc.js";import"./styles-d2f9f396.js";import"./types-3fb18ef5.js";import"./SecretNoumAlertModal-f376a2a7.js";import"./Accordion-ea03839b.js";import"./useResizeObserver-0deb9469.js";import"./Infobox-cf6af02b.js";import"./Radiobox-c1e62033.js";import"./forms-18e3c53a.js";import"./index-594821a1.js";import"./helper-53a5becb.js";import"./OtpInput-6d75f9c8.js";import"./done-439b31ee.js";import"./SetupPin-06f1ecff.js";import"./contactDetails-4902172b.js";import"./countries-4aa86a38.js";import"./index-35efb18f.js";import"./index-4963229a.js";import"./Modal-5a254f40.js";import"./ChamberLeftSideBar-2a7f8e7f.js";import"./index-2d186805.js";import"./sideNavItems-22800105.js";import"./styles-b4894a1f.js";const Ne=({onDelete:n,onSubmit:c,onDuplicate:i,invoice:o,...a})=>{const{isMobile:r}=Y(),d=N(),{logError:m}=$(),{openModal:v,closeModal:s,modalType:f}=z(),I=A(),{formState:{isValid:t}}=we({defaultValues:Ce.fromInvoice(o)}),w=()=>{o.id&&d(T(y.INVOICE_EDIT,{id:o.id}))},h=async()=>{try{await(n==null?void 0:n()),d({pathname:y.INVOICE_MANAGER})}catch{m(new Error("Unable to delete an invoice. Please try again later."),"onDelete")}},P=r?e(ee,{containerWidth:"125px",neutral:!0,onClick:()=>{},menuOptions:[{key:"edit",label:"Edit",type:"value",value:"edit",intent:"default",onClick:w},{key:"delete",label:"Delete",type:"value",value:"delete",intent:"danger",onClick:h}],iconColorToken:"--button-card-neutral-default","data-test":"InvoicePreviewDraftHeader-DraftButtons-EllipsisMenu"}):u(S,{children:[I.canDuplicate(o)&&e(l,{size:"small",tertiary:!0,leftIcon:e(p,{name:"copy_m",size:16,"data-test":"InvoicePreviewDraftHeader-DraftButtons-Icon"}),onClick:i,"data-test":"InvoicePreviewDraftHeader-DraftButtons-Button",children:"Duplicate"}),e(l,{size:"small",tertiary:!0,onClick:w,leftIcon:e(p,{name:"edit_m",size:16,"data-test":"InvoicePreviewDraftHeader-DraftButtons-Icon"}),"data-test":"InvoicePreviewDraftHeader-DraftButtons-Button",children:"Edit"}),e(l,{size:"small",intent:"negative",secondary:!0,leftIcon:e(p,{name:"delete_m",size:16,"data-test":"InvoicePreviewDraftHeader-DraftButtons-Icon"}),onClick:()=>v("deleteDraft"),"data-test":"InvoicePreviewDraftHeader-DraftButtons-Button",children:"Delete"}),e(l,{size:"small",tooltipText:t?"":"Please note that you cannot send an incomplete invoice. To proceed, switch to Edit Mode and provide all required data.",tooltipPosition:"bottom-left",intent:"positive",type:"submit",disabled:!t,onClick:c,"data-test":"InvoicePreviewDraftHeader-DraftButtons-Button",children:"Confirm & Send"})]});return u(S,{children:[e(Q,{...a,buttons:P,isFullScreenMode:!0,"data-test":"InvoicePreviewDraftHeader-StickyFormHeader"}),e(fe,{isOpenModal:f==="deleteDraft",onConfirm:h,onClose:()=>s(),"data-test":"InvoicePreviewDraftHeader-DeleteDraftModal"})]})},Ae=({onSubmit:n,onDuplicate:c,invoice:i,...o})=>{const{isMobile:a}=Y(),r=A(),d=a?e(ee,{containerWidth:"125px",neutral:!0,onClick:()=>{},menuOptions:[{key:"confirm",label:"Confirm & Send",type:"value",value:"confirm",intent:"default",onClick:n}],iconColorToken:"--button-card-neutral-default","data-test":"InvoicePreviewHeader-PreviewButtons-EllipsisMenu"}):u(S,{children:[r.canDuplicate(i)&&e(l,{size:"small",tertiary:!0,leftIcon:e(p,{name:"copy_m",size:16,"data-test":"InvoicePreviewHeader-PreviewButtons-Icon"}),onClick:c,"data-test":"InvoicePreviewHeader-PreviewButtons-Button",children:"Duplicate"}),e(l,{size:"small",intent:"positive",type:"submit",onClick:n,"data-test":"InvoicePreviewHeader-PreviewButtons-Button",children:"Confirm & Send"})]});return e(Q,{...o,buttons:d,isFullScreenMode:!0,"data-test":"InvoicePreviewHeader-StickyFormHeader"})},_e=({onDelete:n,onSubmit:c,onDuplicate:i,onRefetchInvoice:o,invoice:a,status:r,...d})=>{var B;const m=J(),{openModal:v,closeModal:s,modalType:f}=z(),I=A(),{download:t,loading:w}=te(),h=a.id??"",P=N(),{changeStatus:_}=Me(),{data:D,loading:R,refetch:g}=q({variables:{invoiceId:a.id},fetchPolicy:"cache-and-network"}),F=async(b,H)=>{a!=null&&a.id&&(s(),await _({invoice:a,status:b,amount:H}),Ie.delay(()=>{m.refetchQueries({include:[x],onQueryUpdated:E=>{E.refetch({invoiceId:a.id})}}),o==null||o()},500))},C=((B=D==null?void 0:D.getInvoiceAmount)==null?void 0:B.remainingAmount)??0,k=()=>{h&&P(T(y.INVOICE_EDIT,{id:h}))},M=async()=>{setTimeout(()=>{m.refetchQueries({include:[x]}),g()},1500)},O=u(S,{children:[I.canDuplicate(a)?e(l,{size:"small",tertiary:!0,leftIcon:e(p,{name:"copy_m",size:16,"data-test":"InvoicePreviewIssuedHeader-Buttons-Icon"}),onClick:i,"data-test":"InvoicePreviewIssuedHeader-Buttons-Button",children:"Duplicate"}):null,I.canEdit(a)?e(l,{size:"small",tertiary:!0,leftIcon:e(p,{name:"edit_m",size:16,"data-test":"InvoicePreviewIssuedHeader-Buttons-Icon"}),type:"submit",onClick:k,"data-test":"InvoicePreviewIssuedHeader-Buttons-Button",children:"Edit"}):null,I.canDownload(a)?e(l,{size:"small",leftIcon:e(p,{name:"download_m",size:16,"data-test":"InvoicePreviewIssuedHeader-Buttons-Icon"}),tertiary:!0,type:"submit",loading:w,onClick:()=>t(a.id,a.invoiceNumber??""),"data-test":"InvoicePreviewIssuedHeader-Buttons-Button",children:"Download PDF"}):null,I.canChangeStatus(a)?e(l,{size:"small",leftIcon:e(p,{name:"transfer_m",size:16,"data-test":"InvoicePreviewIssuedHeader-Buttons-Icon"}),tertiary:!0,type:"submit",onClick:()=>v("change-status"),"data-test":"InvoicePreviewIssuedHeader-Buttons-Button",children:"Change Status"}):null,I.canPay(a)?u(l,{size:"small",leftIcon:e(p,{name:"lock_m",size:16,"data-test":"InvoicePreviewIssuedHeader-Buttons-Icon"}),primary:!0,loading:R,onClick:()=>v("make-payment",a),disabled:C<=0,"data-test":"InvoicePreviewIssuedHeader-Buttons-Button",children:[C<(a.amount??0)?"Pay missing ":"Pay ",G(C,a.currency??void 0)]}):null]});return u(S,{children:[e(Q,{...d,buttons:O,isFullScreenMode:!0,"data-test":"InvoicePreviewIssuedHeader-StickyFormHeader"}),e(De,{isOpenModal:f==="change-status",onCancel:s,onConfirm:F,currentStatus:r??void 0,currency:a.currency??void 0,invoiceId:a.id??"","data-test":`InvoicePreviewIssuedHeader-ChangeInvoiceStatusModal-${f}`},f),f==="make-payment"&&e(ae,{onClose:s,invoice:a,onPaymentSuccess:M,"data-test":"InvoicePreviewIssuedHeader-MakeInvoicePaymentWizard"})]})},Re=({invoice:n})=>{var h;const c=J(),{openModal:i,closeModal:o,modalType:a}=z(),r=A(),{download:d,loading:m}=te(),v=n.id??"",{data:s,loading:f,refetch:I}=q({variables:{invoiceId:n.id},fetchPolicy:"cache-and-network"}),t=((h=s==null?void 0:s.getInvoiceAmount)==null?void 0:h.remainingAmount)??0,w=async()=>{c.refetchQueries({include:[x]}),setTimeout(()=>{I(),c.refetchQueries({include:[ne],onQueryUpdated:P=>{P.refetch({id:v})}})},1e3)};return u(L,{gap:16,"data-test":"UnauthenticatedUserHeaderButtons-Stack",children:[r.canDownload(n)?e(l,{size:"small",leftIcon:e(p,{name:"download_m",size:16,"data-test":"UnauthenticatedUserHeaderButtons-Icon"}),tertiary:!0,type:"submit",loading:m,onClick:()=>d(n.id,n.invoiceNumber??""),"data-test":"UnauthenticatedUserHeaderButtons-Button",children:"Download PDF"}):null,r.canPay(n)?u(l,{size:"small",leftIcon:e(p,{name:"lock_m",size:16,"data-test":"UnauthenticatedUserHeaderButtons-Icon"}),primary:!0,loading:f,onClick:()=>i("make-payment",n),disabled:t<=0,"data-test":"UnauthenticatedUserHeaderButtons-Button",children:[t<(n.amount??0)?"Pay missing ":"Pay ",G(t,n.currency??void 0)]}):null,a==="make-payment"&&e(ae,{onClose:o,invoice:n,onPaymentSuccess:w,"data-test":"UnauthenticatedUserHeaderButtons-MakeInvoicePaymentWizard"})]})},Fe=({isOpenModal:n,amount:c,currency:i,customerName:o,onConfirm:a,onCancel:r})=>{const[d,m]=W.useState(!1),v=async()=>{m(!0),await a(),m(!1)};return u(oe,{isFullScreen:!1,open:n,testId:"add_new_customer_modal",size:ie.S,isScrollableContent:!1,"data-test":"ReviewInvoiceConfirmatioModal-Modal",children:[e(re,{"data-test":"ReviewInvoiceConfirmatioModal-ModalHeader",children:"Review Invoice"}),u(se,{gap:16,maxHeight:600,"data-test":"ReviewInvoiceConfirmatioModal-ModalBody",children:[u(U,{textAlign:"center",font:"body-l",colorToken:"--text-modal-neutral-default","data-test":"ReviewInvoiceConfirmatioModal-TSpan",children:["Do you confirm the issuance of an invoice for"," ",e(U,{font:"body-l-bold","data-test":"ReviewInvoiceConfirmatioModal-TSpan",children:G(c,i,2)})," ","to ",e(U,{font:"body-l-bold","data-test":"ReviewInvoiceConfirmatioModal-TSpan",children:o}),"?"]}),e(U,{textAlign:"center",font:"body-l",colorToken:"--text-modal-neutral-default","data-test":"ReviewInvoiceConfirmatioModal-TSpan",children:"Invoices can’t be edited after they’ve been paid."}),u(L,{vertical:!0,gap:16,fullWidth:!0,"data-test":"ReviewInvoiceConfirmatioModal-Stack",children:[e(l,{size:"full",primary:!0,onClick:v,loading:d,"data-test":"ReviewInvoiceConfirmatioModal-Button",children:"Confirm & Send to Customer"}),e(l,{size:"full",tertiary:!0,onClick:r,"data-test":"ReviewInvoiceConfirmatioModal-Button",children:"Continue Editing"})]})]})]})};function Oe({invoiceId:n}){const{deleteInvoice:c,sendInvoice:i,duplicateInvoice:o,refetchInvoice:a,invoice:r,loading:d}=Se({invoiceId:n}),{addErrorToast:m}=X(),v=W.useCallback(async()=>{try{const s=await o();s!=null&&s.id&&window.open(ze.createInvoicePath.duplicateInvoice(s.id),"_blank")}catch{m("Failed to duplicate invoice")}},[m,o]);return{invoice:r,loading:d,sendInvoice:i,deleteInvoice:c,handleDuplicate:v,refetchInvoice:a}}const xe=({status:n})=>{const c=N(),{id:i}=K(),o=Z();W.useEffect(()=>{i&&n&&n!==V.Draft&&T(y.INVOICE_PREVIEW,{id:i})===o.pathname&&c(T(y.INVOICE_DETAILS,{id:i}),{replace:!0})},[i,o.pathname,c,n])},Ve=()=>{var k;const{id:n}=K(),c=Z(),{logError:i}=$(),o=N(),{openModal:a,closeModal:r,modalType:d,contextData:m}=z(),{addSuccessIconToast:v}=X(),s=!c.pathname.includes("/preview"),{isUnauthenticated:f}=ce(),{deleteInvoice:I,invoice:t,loading:w,sendInvoice:h,handleDuplicate:P,refetchInvoice:_}=Oe({invoiceId:n});xe({status:t==null?void 0:t.status});const[D]=He(),{goBackToOrigin:R}=Ee(),g=async()=>{var B,b,H,E;const{isConnected:M,isSecretNoum:O}=await D(((B=t==null?void 0:t.noumId)==null?void 0:B._id)??"",((b=t==null?void 0:t.invoiceTo)==null?void 0:b._id)??"",(H=t==null?void 0:t.noumId)==null?void 0:H.projectType);O&&!M?a("secretNoumAlert",me.isUnauthenticated((E=t==null?void 0:t.invoiceTo)==null?void 0:E.userId)):a("confirmation")},F=async()=>{var M;try{await h(),v(`Your invoice has been sent to ${(M=t==null?void 0:t.invoiceTo)==null?void 0:M.displayName}`),o(y.INVOICE_MANAGER)}catch{i(new Error("Unable to send an invoice. Please try again later."),"onConfirm")}},C=()=>{R({fallbackUrl:y.INVOICE_MANAGER})};return!n||!w&&!t?e(pe,{replace:!0,to:y.INVOICE_MANAGER,"data-test":"InvoicePreviewScreen-Navigate"}):u(Ue,{"data-test":"InvoicePreviewScreen-FullScreenLayout",children:[e(S,{children:!t&&w?e(de,{"data-test":"InvoicePreviewScreen-Spinner"}):t?u(S,{children:[e(j.FormHeaderContainer,{children:f?e(le,{isBorderRadius:!1,"data-test":"InvoicePreviewScreen-Header",children:e(ve,{title:"Your Invoice",rightElement:e(Re,{invoice:t,"data-test":"InvoicePreviewScreen-UnauthenticatedUserHeaderButtons"}),"data-test":"InvoicePreviewScreen-UnauthenticatedHeader"})}):!s&&(t==null?void 0:t.status)===V.Draft?e(Ae,{title:"Invoice Summary",onSubmit:g,onGoBack:C,invoice:t,onDuplicate:()=>a("duplicate-invoice"),"data-test":"InvoicePreviewScreen-InvoicePreviewHeader"}):s&&(t==null?void 0:t.status)===V.Draft?e(Ne,{title:"Invoice Summary",onDelete:I,invoice:t,onSubmit:g,onGoBack:C,onDuplicate:()=>a("duplicate-invoice"),"data-test":"InvoicePreviewScreen-InvoicePreviewDraftHeader"}):e(_e,{title:"Invoice Summary",onDelete:I,invoice:t,onSubmit:g,status:t==null?void 0:t.status,onGoBack:C,onRefetchInvoice:_,onDuplicate:()=>a("duplicate-invoice"),"data-test":"InvoicePreviewScreen-InvoicePreviewIssuedHeader"})}),e(Te,{"data-test":"InvoicePreviewScreen-ResponsiveMain",children:e(j.Content,{gap:16,padding:"16px 0",oneColumn:!0,children:t?u(L,{vertical:!0,gap:16,"data-test":"InvoicePreviewScreen-Stack",children:[e(ge,{invoice:t,"data-test":"InvoicePreviewScreen-PlanDetails"}),e(Be,{invoice:t,"data-test":"InvoicePreviewScreen-InvoiceSummary"}),e(ke,{invoice:t,"data-test":"InvoicePreviewScreen-InvoiceDetailsSection"}),e(be,{invoice:t,"data-test":"InvoicePreviewScreen-InvoiceTimeline"})]}):null})})]}):null}),t&&e(Fe,{isOpenModal:d==="confirmation",amount:(t==null?void 0:t.amount)??0,currency:(t==null?void 0:t.currency)??ue.Usd,customerName:((k=t.invoiceTo)==null?void 0:k.displayName)||"",onConfirm:F,onCancel:r,"data-test":"InvoicePreviewScreen-ReviewInvoiceConfirmatioModal"}),e(Pe,{isOpenModal:d==="secretNoumAlert",onClose:r,isUnauthenticated:!!m,"data-test":"InvoicePreviewScreen-InvoiceSecretNoumAlertModal"}),e(he,{isOpenModal:d==="duplicate-invoice",onClose:r,onConfirm:()=>{P(),r()},"data-test":"InvoicePreviewScreen-DuplicateInvoiceModal"})]})},kt=()=>e(ye,{"data-test":"InvoiceProvider",children:e(Ve,{"data-test":"InvoicePreviewScreen"})});export{kt as default};
//# sourceMappingURL=InvoicePreview-d7c3cebe.js.map
